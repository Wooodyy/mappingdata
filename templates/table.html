<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Таблица данных</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              inter: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
  </head>
  <body class="min-h-screen bg-white font-inter">
    <main class=" max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-4">

      <!-- Updated main table header to match compare.html style -->
      <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
        <div class="bg-slate-700 px-6 pt-6 rounded-2xl">
          <div class="flex justify-between items-center">
            <h2 class="text-xl font-semibold text-white flex items-center">
              <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="3" y="5" width="18" height="14" rx="2" ry="2" stroke-width="2"/>
                <line x1="3" y1="9" x2="21" y2="9" stroke-width="2"/>
                <line x1="9" y1="9" x2="9" y2="19" stroke-width="2"/>
                <line x1="15" y1="9" x2="15" y2="19" stroke-width="2"/>
              </svg>
              Таблица данных
            </h2>
            
            <!-- Поле поиска в центре -->
            <div class="flex items-center space-x-3 flex-1 max-w-md mx-8">
              <div class="flex-1 relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </div>
                <input 
                  type="text" 
                  id="search-input" 
                  placeholder="Поиск по контейнерам, товарам, кодам ТН ВЭД..." 
                  class="w-full pl-10 pr-4 py-2 bg-white border border-slate-300 rounded-lg text-sm text-slate-900 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-slate-500 transition-colors duration-200"
                />
              </div>
              <button 
                id="clear-search-btn" 
                class="px-3 py-2 bg-slate-600 text-white text-sm font-medium rounded-lg hover:bg-slate-700 transition-colors duration-200 shadow-sm"
                style="display: none;"
              >
                Очистить
              </button>
            </div>
            
            <!-- Кнопки справа -->
            <div class="flex space-x-2">
          <!-- Updated button styles to match muted theme -->
          <button id="copy-btn" class="inline-flex items-center px-4 py-2 bg-white text-slate-700 text-sm border border-slate-300 font-medium rounded-lg hover:bg-slate-100 hover:text-slate-900 transition-colors duration-200 shadow-sm">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            Скопировать
          </button>
            <button id="save-btn" class="inline-flex items-center px-4 py-2 border-2 border-slate-500 bg-slate-600 text-white text-sm font-medium rounded-lg hover:bg-slate-700 transition-colors duration-200 shadow-sm">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
              </svg>
              Сохранить
          </button>
            <button id="download-btn" class="inline-flex items-center px-4 py-2 border-2 border-green-500 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors duration-200 shadow-sm" style="display: none;">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Скачать JSON
          </button>
          <button onclick="goBackToUpload()" class="inline-flex items-center gap-2 px-4 py-2 border-2 border-slate-500 bg-slate-600 hover:bg-slate-700 text-white rounded-lg transition-colors duration-200 text-sm font-medium shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
            </svg>
            Загрузить новый файл
          </button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <!-- Таблицы будут генерироваться динамически -->
        </div>
        <!-- Updated loading spinner color to match theme -->
        <div id="loading-state" class="flex items-center justify-center py-12">
          <div class="flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-slate-600"></div>
            <span class="text-slate-600">Загрузка данных...</span>
          </div>
        </div>
      </div>
    
    </main>
    <!-- Updated toast notification styles to match muted theme -->
    <div id="toast" class="fixed top-4 right-4 transform translate-x-full transition-transform duration-300 ease-in-out z-50">
      <div class="bg-slate-700 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-3">
        <svg class="w-5 h-5 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span id="toast-message">Скопировано в буфер обмена</span>
      </div>
    </div>

    <script>
      function formatNumber(value) {
        // Если это строка с множественными нулями, сначала очищаем её
        if (typeof value === 'string') {
          // Убираем лишние нули в конце
          value = value.replace(/\.?0+$/, '');
        }
        
        const num = parseFloat(value);
        if (isNaN(num)) return value;
        
        // Округляем до 2 знаков после запятой, чтобы убрать лишние нули
        const rounded = Math.round(num * 100) / 100;
        
        return rounded.toLocaleString('ru-RU', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 2
        });
      }

      function formatDate(dateString) {
        if (!dateString || dateString === "Не указана" || dateString.trim() === "") {
          return "Не указана";
        }
        
        try {
          // Пытаемся распарсить дату в различных форматах
          let date;
          
          // Если дата уже в формате DD.MM.YYYY
          if (/^\d{2}\.\d{2}\.\d{4}$/.test(dateString.trim())) {
            return dateString.trim();
          }
          
          // Если дата в формате YYYY-MM-DD
          if (/^\d{4}-\d{2}-\d{2}$/.test(dateString.trim())) {
            date = new Date(dateString.trim());
          }
          // Если дата в формате DD/MM/YYYY
          else if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateString.trim())) {
            const parts = dateString.trim().split('/');
            date = new Date(parts[2], parts[1] - 1, parts[0]);
          }
          // Если дата в формате MM/DD/YYYY
          else if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateString.trim())) {
            const parts = dateString.trim().split('/');
            date = new Date(parts[2], parts[0] - 1, parts[1]);
          }
          // Если дата содержит время (ISO формат)
          else if (dateString.includes('T')) {
            date = new Date(dateString);
          }
          // Пытаемся создать дату из строки
          else {
            date = new Date(dateString);
          }
          
          // Проверяем, что дата валидна
          if (isNaN(date.getTime())) {
            return dateString; // Возвращаем исходную строку если не удалось распарсить
          }
          
          // Форматируем в DD.MM.YYYY
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = date.getFullYear();
          
          return `${day}.${month}.${year}`;
        } catch (error) {
          console.error("Ошибка форматирования даты:", error);
          return dateString; // Возвращаем исходную строку при ошибке
        }
      }

      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const toastContent = toast.querySelector("div");
        
        toastContent.className = type === "success" 
          ? "bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2"
          : "bg-red-600 text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2";
        
        toastContent.querySelector("span").textContent = message;
        toast.classList.remove("translate-x-full");
        setTimeout(() => toast.classList.add("translate-x-full"), 1000);
      }

      async function fetchData() {
        try {
          const savedData = localStorage.getItem("mapato_data");
          console.log("Данные из localStorage:", savedData);
          
          if (!savedData) {
            showNoDataMessage();
            return Promise.resolve();
          }

          const data = JSON.parse(savedData);
          console.log("Распарсенные данные:", data);
          console.log("Контейнеры:", data.containers);
          console.log("Калькуляция:", data.calc);
          
          const uploadTime = localStorage.getItem("mapato_upload_time");

          document.getElementById("loading-state").style.display = "none";
          generateTable(data.containers);
          
          return Promise.resolve();
        } catch (error) {
          console.error("Error loading data:", error);
          showToast("Ошибка загрузки данных", "error");
          showErrorMessage();
          return Promise.resolve();
        }
      }

      function showNoDataMessage() {
        document.getElementById("loading-state").innerHTML = `
          <div class="flex flex-col items-center justify-center py-12 space-y-4">
            <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="text-center">
              <p class="text-lg font-semibold text-gray-600">Нет загруженных данных</p>
              <p class="text-gray-500 mt-2">Сначала загрузите файл для обработки</p>
              <a href="/" class="inline-flex items-center mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                Загрузить файл
              </a>
            </div>
          </div>
        `;
      }

      function showErrorMessage() {
        document.getElementById("loading-state").innerHTML = `
          <div class="flex flex-col items-center justify-center py-12 space-y-4">
            <svg class="w-16 h-16 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="text-center">
              <p class="text-lg font-semibold text-red-600">Ошибка загрузки данных</p>
              <p class="text-gray-500 mt-2">Возможно, данные повреждены</p>
              <button onclick="clearLocalData()" class="inline-flex items-center mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Очистить данные
              </button>
            </div>
          </div>
        `;
      }


      // Generate table headers and rows
      function generateTable(data) {
        console.log("generateTable вызвана с данными:", data);
        
        // Проверяем, есть ли данные в контейнерах
        if (!data || Object.keys(data).length === 0) {
            console.log("Нет данных для отображения");
            const tableWrapper = document.querySelector(".overflow-x-auto");
            if (tableWrapper) {
              tableWrapper.innerHTML = '<div class="text-center py-8 text-slate-500">Нет данных для отображения</div>';
            }
            return;
          }
        
        // Генерируем группированные таблицы
          generateGroupedTables(data);
      }


      // Генерация таблиц по группам контейнеров
      function generateGroupedTables(containerData) {
        console.log("generateGroupedTables вызвана с данными:", containerData);
        
        const tableContainer = document.querySelector(
          ".bg-white.rounded-lg.shadow-sm.border.border-slate-200.overflow-hidden"
        );
        
        console.log("Найденный контейнер таблицы:", tableContainer);

        if (Object.keys(containerData).length === 0) {
          const tableWrapper = tableContainer.querySelector(".overflow-x-auto");
          console.log("Найденный wrapper:", tableWrapper);
          tableWrapper.innerHTML = '<div class="text-center py-8 text-slate-500">Нет данных для отображения</div>';
          return;
        }

        // Очищаем существующую таблицу
        const tableWrapper = tableContainer.querySelector(".overflow-x-auto");
        tableWrapper.innerHTML = "";

        // Скрываем общую кнопку копирования, так как теперь всегда используются группированные данные
        const generalCopyBtn = document.getElementById("copy-btn");
        if (generalCopyBtn) {
          generalCopyBtn.style.display = "none";
        }

        // Определяем ширину столбцов в процентах
        const columnWidths = {};
        let globalRowIndex = 0;

        // Создаем отдельную таблицу для каждого контейнера
        Object.entries(containerData).forEach(([containerNo, rows]) => {
          if (rows.length === 0) return;

          const headers = Object.keys(rows[0]);
          
          // Определяем ширину столбцов для первой таблицы
          if (Object.keys(columnWidths).length === 0) {
            headers.forEach(header => {
              if (header === 'Коммерческое описание товара') {
                columnWidths[header] = '25%';
              } else if (header === 'Код ТН ВЭД') {
                columnWidths[header] = '10%';
              } else if (header === 'Номер контейнера') {
                columnWidths[header] = '12%';
              } else if (header === 'Валюта') {
                columnWidths[header] = '6%';
              } else if (header === 'Сумма') {
                columnWidths[header] = '8%';
              } else if (header === 'Вес брутто') {
                columnWidths[header] = '8%';
              } else {
                columnWidths[header] = '7%';
              }
            });
          }

          // Получаем информацию об отправителе и получателе для этого контейнера
          const savedData = localStorage.getItem("mapato_data");
          let containerSenderInfo = "Не указан";
          let containerRecipientInfo = "Не указан";
          let containerSenderAddress = "Нет данных";
          let containerRecipientAddress = "Нет данных";
          let containerInvoice = "Не указан";
          let containerDateInvoice = "Не указана";
          
          if (savedData) {
            try {
              const data = JSON.parse(savedData);
              if (data.container_info && data.container_info[containerNo]) {
                containerSenderInfo = data.container_info[containerNo].sender_name || "Не указан";
                containerRecipientInfo = data.container_info[containerNo].recipient_name || "Не указан";
                containerSenderAddress = data.container_info[containerNo].sender_address || "Нет данных";
                containerRecipientAddress = data.container_info[containerNo].recipient_address || "Нет данных";
                containerInvoice = data.container_info[containerNo].invoice || "Не указан";
                containerDateInvoice = data.container_info[containerNo].date_invoice || "Не указана";
              }
            } catch (e) {
              console.error("Ошибка при получении информации о контейнере:", e);
            }
          }

          // Рассчитываем итоги для этого контейнера
          let containerTotals = {};
          
          // Определяем числовые поля для суммирования
          const numericFields = ['Количество грузовых мест', 'Количество упаковок', 'Вес брутто', 'Сумма'];
          
          numericFields.forEach(field => {
            if (headers.includes(field)) {
              containerTotals[field] = 0;
            }
          });
          
          rows.forEach(row => {
            numericFields.forEach(field => {
              if (containerTotals.hasOwnProperty(field)) {
                containerTotals[field] += parseFloat(row[field]) || 0;
              }
            });
          });
          
          console.log(`Итоги для контейнера ${containerNo}:`, containerTotals);

          const tableHtml = `
            <div class="mb-6 mt-6 pb-0 bg-slate-50 rounded-2xl">
              <div class="px-0 py-0 bg-slate-700 rounded-2xl mb-0">

                <!-- Информация об инвойсе -->
                <div class="mt-2 mb-2 bg-slate-100 rounded-lg p-3 border border-slate-200">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                      <div class="flex items-center">
                        <div class="w-6 h-6 bg-orange-400 rounded flex items-center justify-center border border-orange-500 mr-2">
                          <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                          </svg>
                        </div>
                        <span class="text-sm font-semibold text-slate-800">Номер Инвойса:</span>
                      </div>
                      <div 
                        class="bg-slate-200 border border-slate-300 rounded px-2 py-1 cursor-pointer hover:bg-slate-300 transition-colors duration-200"
                        onclick="copyToClipboard('${containerInvoice}', 'Номер инвойса скопирован')"
                        title="Кликните для копирования номера инвойса"
                      >
                        <span class="text-sm text-slate-900 font-medium">${containerInvoice}</span>
                      </div>
                    </div>
                    <div class="flex items-center space-x-4">
                      <div class="flex items-center">
                        <div class="w-6 h-6 bg-purple-400 rounded flex items-center justify-center border border-purple-500 mr-2">
                          <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                          </svg>
                        </div>
                        <span class="text-sm font-semibold text-slate-800">Дата:</span>
                      </div>
                      <div 
                        class="bg-slate-200 border border-slate-300 rounded px-2 py-1 cursor-pointer hover:bg-slate-300 transition-colors duration-200"
                        onclick="copyToClipboard('${formatDate(containerDateInvoice)}', 'Дата инвойса скопирована')"
                        title="Кликните для копирования даты инвойса"
                      >
                        <span class="text-sm text-slate-900 font-medium">${formatDate(containerDateInvoice)}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Подробная информация об отправителе и получателе -->
                <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <div class="flex items-center mb-3">
                      <div class="w-6 h-6 bg-blue-400 rounded flex items-center justify-center border border-blue-500 mr-2">
                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                      </div>
                      <span class="text-sm font-semibold text-slate-800">Отправитель</span>
                    </div>
                    <div class="space-y-2">
                      <div>
                        <div class="text-xs font-medium text-slate-700 mb-1">Название</div>
                        <div 
                          class="bg-slate-100 border border-slate-300 rounded p-1 cursor-pointer hover:bg-slate-200 transition-colors duration-200"
                          onclick="copyToClipboard('${containerSenderInfo}', 'Название отправителя скопировано')"
                          title="Кликните для копирования названия отправителя"
                        >
                          <div class="text-sm text-slate-900 break-words leading-relaxed font-medium">${containerSenderInfo}</div>
                        </div>
                      </div>
                      <div>
                        <div class="text-xs font-medium text-slate-700 mb-1">Адрес</div>
                        <div 
                          class="bg-slate-100 border border-slate-300 rounded p-1 cursor-pointer hover:bg-slate-200 transition-colors duration-200"
                          onclick="copyToClipboard('${containerSenderAddress || 'Нет данных'}', 'Адрес отправителя скопирован')"
                          title="Кликните для копирования адреса отправителя"
                        >
                          <div class="text-sm text-slate-900 break-words leading-relaxed font-medium">${containerSenderAddress || 'Нет данных'}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <div class="flex items-center mb-3">
                      <div class="w-6 h-6 bg-green-400 rounded flex items-center justify-center border border-green-500 mr-2">
                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                      </div>
                      <span class="text-sm font-semibold text-slate-800">Получатель</span>
                    </div>
                    <div class="space-y-2">
                      <div>
                        <div class="text-xs font-medium text-slate-700 mb-1">Название</div>
                        <div 
                          class="bg-slate-100 border border-slate-300 rounded p-1 cursor-pointer hover:bg-slate-200 transition-colors duration-200"
                          onclick="copyToClipboard('${containerRecipientInfo}', 'Название получателя скопировано')"
                          title="Кликните для копирования названия получателя"
                        >
                          <div class="text-sm text-slate-900 break-words leading-relaxed font-medium">${containerRecipientInfo}</div>
                        </div>
                      </div>
                      <div>
                        <div class="text-xs font-medium text-slate-700 mb-1">Адрес</div>
                        <div 
                          class="bg-slate-100 border border-slate-300 rounded p-1 cursor-pointer hover:bg-slate-200 transition-colors duration-200"
                          onclick="copyToClipboard('${containerRecipientAddress || 'Нет данных'}', 'Адрес получателя скопирован')"
                          title="Кликните для копирования адреса получателя"
                        >
                          <div class="text-sm text-slate-900 break-words leading-relaxed font-medium">${containerRecipientAddress || 'Нет данных'}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex justify-between items-center cursor-pointer bg-slate-50  hover:bg-slate-300 transition-colors duration-200 rounded-lg p-2 mt-2 " onclick="toggleContainer('${containerNo}')">
                  <div class="flex items-center">
                    <button
                      onclick="event.stopPropagation(); toggleContainer('${containerNo}')"
                      class="mr-3 p-1 bg-white border-2 border-slate-300 rounded-lg transition-colors duration-200 text-slate-600 hover:text-white hover:bg-slate-600"
                      id="toggle-btn-${containerNo}"
                    >
                      <svg class="w-5 h-5 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="toggle-icon-${containerNo}" style="transform: rotate(-90deg);">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                      </svg>
                    </button>
                    <h3 class="text-lg font-semibold text-slate-800">
                      Контейнер ${
                        Object.keys(containerData).indexOf(containerNo) + 1
                      }: 
                      <span 
                        class="bg-slate-50 border-2 border-slate-400 hover:bg-slate-700 hover:border-slate-900 hover:text-slate-50 px-2 py-1 rounded cursor-pointer transition-colors duration-200"
                        onclick="event.stopPropagation(); copyContainerNoToClipboard('${containerNo}')"
                        title="Кликните для копирования номера контейнера"
                      >
                        ${containerNo}
                      </span>
                      <span class="text-sm font-normal text-slate-600 ml-2">(${
                        rows.length
                      } позиций)</span>
                    </h3>
                  </div>
                  <div class="flex space-x-2" onclick="event.stopPropagation()">
                    <button
                      onclick="copyContainerToClipboard('${containerNo}')"
                      class="inline-flex items-center px-3 py-1 bg-white text-slate-800 text-sm border border-gray-300 font-medium rounded-lg hover:bg-blue-600 hover:text-white transition-colors duration-200 shadow-sm"
                    >
                      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                      </svg>
                      Скопировать таблицу
                    </button>
                  </div>
                </div>
                

                
              </div>
              <div class="overflow-x-auto transition-all duration-300" id="container-content-${containerNo}" style="display: none;">
                <table class="w-full container-table" data-container="${containerNo}" style="table-layout: fixed;">
                  <thead class="bg-slate-50 border-b border-slate-200">
                    <tr>
                      ${headers
                        .filter((header) => header !== "Case No")
                        .map(
                          (header) => `
                          <th class="px-3 py-3 text-left text-xs font-semibold text-slate-700 tracking-normal border-r border-slate-200" style="width: ${columnWidths[header] || '7%'}; min-width: ${columnWidths[header] || '7%'}; max-width: ${columnWidths[header] || '7%'}; word-wrap: break-word;">
                            ${header === "Вид упаковки " ? `
                              <div class="space-y-2">
                                <div title="${header}">${header}</div>
                                <select 
                                  class="bulk-package-type-select text-xs bg-white border border-slate-300 rounded px-1 py-1 focus:outline-none focus:ring-1 focus:ring-slate-500 focus:border-slate-500 w-full"
                                  onchange="changeBulkPackageTypeForContainer('${containerNo}', this.value)"
                                >
                                  <option value="">Изменить все</option>
                                  <option value="BG">BG</option>
                                  <option value="BX">BX</option>
                                  <option value="CT">CT</option>
                                  <option value="PK">PK</option>
                                  <option value="CS">CS</option>
                                  <option value="PP">PP</option>
                                  <option value="FR">FR</option>
                                  <option value="PX">PX</option>
                                  <option value="NF">NF</option>
                                </select>
                              </div>
                            ` : header === "Информация об упаковке (0-БЕЗ, 1 С)" ? `
                              <div class="space-y-2">
                                <div title="${header}">${header}</div>
                                <select 
                                  class="bulk-package-info-select text-xs bg-white border border-slate-300 rounded px-1 py-1 focus:outline-none focus:ring-1 focus:ring-slate-500 focus:border-slate-500 w-full"
                                  onchange="changeBulkPackageInfoForContainer('${containerNo}', this.value)"
                                >
                                  <option value="">Изменить все</option>
                                  <option value="0">0 - БЕЗ</option>
                                  <option value="1">1 - С</option>
                                </select>
                              </div>
                            ` : `
                              <div title="${header}">${header}</div>
                            `}
                          </th>
                      `
                        )
                        .join("")}
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-200">
                    ${rows
                      .map(
                        (row, index) => `
                        <tr class="hover:bg-slate-50 transition-colors duration-150 ${
                          index % 2 === 0 ? "bg-white" : "bg-slate-25"
                        }">
                            ${Object.entries(row)
                              .filter(([key, value]) => key !== "Case No")
                              .map(
                                ([key, value]) => `
                                <td class="px-3 py-2 text-sm text-slate-900 border-r border-slate-200 ${
                                  key === "Коммерческое описание товара"
                                    ? "min-w-0 relative"
                                    : "whitespace-nowrap"
                                }" style="width: ${columnWidths[key] || '7%'}; min-width: ${columnWidths[key] || '7%'}; max-width: ${columnWidths[key] || '7%'};">
                                    ${
                                      key === "Коммерческое описание товара"
                                        ? `
                                        <div 
                                            class="text-sm leading-tight"
                                            style="word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;"
                                        >
                                            ${value}
                                        </div>
                                        `
                                        : key === "Вид упаковки "
                                        ? `
                                        <select 
                                            class="package-type-select text-sm bg-white border border-slate-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-slate-500 w-full"
                                            onchange="updatePackageType('${containerNo}', ${index}, this.value)"
                                            data-row-index="${globalRowIndex}"
                                            data-container="${containerNo}"
                                        >
                                            <option value="BG" ${
                                              value === "BG" ? "selected" : ""
                                            }>BG</option>
                                            <option value="BX" ${
                                              value === "BX" ? "selected" : ""
                                            }>BX</option>
                                            <option value="CT" ${
                                              value === "CT" ? "selected" : ""
                                            }>CT</option>
                                            <option value="PK" ${
                                              value === "PK" ? "selected" : ""
                                            }>PK</option>
                                            <option value="CS" ${
                                              value === "CS" ? "selected" : ""
                                            }>CS</option>
                                            <option value="PP" ${
                                              value === "PP" ? "selected" : ""
                                            }>PP</option>
                                            <option value="FR" ${
                                              value === "FR" ? "selected" : ""
                                            }>FR</option>
                                            <option value="PX" ${
                                              value === "PX" ? "selected" : ""
                                            }>PX</option>
                                            <option value="NF" ${
                                              value === "NF" ? "selected" : ""
                                            }>NF</option>
                                        </select>
                                    `
                                        : key === "Информация об упаковке (0-БЕЗ, 1 С)"
                                        ? `
                                        <select 
                                            class="package-info-select text-sm bg-white border border-slate-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-slate-500 w-full"
                                            onchange="updatePackageInfo('${containerNo}', ${index}, this.value)"
                                            data-row-index="${globalRowIndex}"
                                            data-container="${containerNo}"
                                        >
                                            <option value="0" ${
                                              value == 0 ? "selected" : ""
                                            }>0 - БЕЗ</option>
                                            <option value="1" ${
                                              value == 1 ? "selected" : ""
                                            }>1 - С</option>
                                        </select>
                                    `
                                        : (() => {
                                          // Определяем числовые поля
                                          const numericFields = ['Количество грузовых мест', 'Количество упаковок', 'Вес брутто', 'Сумма'];
                                          if (numericFields.includes(key) && value !== null && value !== undefined && value !== '') {
                                            return formatNumber(value);
                                          }
                                          return value;
                                        })()
                                    }
                                </td>
                            `
                              )
                              .join("")}
                        </tr>
                    `
                      )
                      .join("")}
                      
                      <!-- Строка итогов для контейнера -->
                      <tr class="bg-slate-100 border-t-2 border-slate-300 font-medium">
                        ${headers
                          .filter((header) => header !== "Case No")
                          .map((header) => {
                            const width = columnWidths[header] || '7%';
                            
                            if (containerTotals.hasOwnProperty(header)) {
                              const value = containerTotals[header];
                              return `<td class="px-3 py-2 bg-slate-300 text-sm text-slate-800 whitespace-nowrap border-r border-slate-200 font-semibold" style="width: ${width}; min-width: ${width}; max-width: ${width};">
                                ${formatNumber(value)}
                              </td>`;
                            } else if (header === 'Код ТН ВЭД') {
                              return `<td class="px-3 py-2 bg-slate-300 text-sm text-slate-800 whitespace-nowrap font-semibold border-r border-slate-200" style="width: ${width}; min-width: ${width}; max-width: ${width};">ИТОГО:</td>`;
                            } else {
                              return `<td class="px-3 py-2 bg-slate-300 text-sm text-slate-500 whitespace-nowrap border-r border-slate-200" style="width: ${width}; min-width: ${width}; max-width: ${width};"></td>`;
                            }
                          })
                          .join('')}
                      </tr>
                  </tbody>
                </table>
              </div>
            </div>
          `;

          globalRowIndex += rows.length;
          tableWrapper.insertAdjacentHTML("beforeend", tableHtml);
        });


        // Добавляем функцию для сворачивания/разворачивания контейнеров
        window.toggleContainer = function (containerNo) {
          const content = document.getElementById(
            `container-content-${containerNo}`
          );
          const icon = document.getElementById(`toggle-icon-${containerNo}`);

          if (content.style.display === "none") {
            content.style.display = "block";
            icon.style.transform = "rotate(0deg)";
          } else {
            content.style.display = "none";
            icon.style.transform = "rotate(-90deg)";
          }
        };
      }





      // Copy table to clipboard
      function copyTableToClipboard() {
        // Эта функция больше не используется, так как копирование происходит через контейнеры
        showToast("Используйте кнопки копирования для каждого контейнера", "error");
      }

      // Copy specific container table to clipboard
      function copyContainerToClipboard(containerNo) {
        const containerTable = document.querySelector(
          `[data-container="${containerNo}"]`
        );

        if (!containerTable) {
          showToast("Контейнер не найден", "error");
          return;
        }

        //let text = `Контейнер: ${containerNo}\n`;
        let text = "";

        // Get rows for this container, excluding the totals row
        containerTable.querySelectorAll("tbody tr").forEach((row) => {
          // Проверяем, является ли строка строкой итогов
          const isTotalsRow = row.classList.contains('bg-slate-100') && 
                             row.classList.contains('border-t-2') && 
                             row.classList.contains('border-slate-300');
          
          // Пропускаем строку итогов
          if (isTotalsRow) {
            return;
          }
          
          const cells = [...row.querySelectorAll("td")].map((td) => {
            // Проверяем, есть ли в ячейке селект для вида упаковки
            const packageSelect = td.querySelector("select.package-type-select");
            if (packageSelect) {
              // Если есть селект вида упаковки, берем его выбранное значение
              return packageSelect.value;
            }
            // Проверяем, есть ли в ячейке селект для информации об упаковке
            const packageInfoSelect = td.querySelector("select.package-info-select");
            if (packageInfoSelect) {
              // Если есть селект информации об упаковке, берем его выбранное значение
              return packageInfoSelect.value;
            }
            // Иначе берем обычный текст
            return td.textContent.trim();
          });
          text += cells.join("\t") + "\n";
        });

        text = text.replace(/\./g, ","); // Заменить все точки на запятые

        navigator.clipboard
          .writeText(text)
          .then(() => {
            showToast(`Контейнер ${containerNo} скопирован в буфер обмена!`);
          })
          .catch((err) => {
            console.error("Ошибка копирования:", err);
            showToast("Ошибка копирования данных", "error");
          });
      }

      function copyToClipboard(text, successMessage) {
        if (!text || text === "Загрузка..." || text === "Не указан") {
          showToast("Нет данных для копирования", "error");
          return;
        }
        navigator.clipboard.writeText(text)
          .then(() => showToast(successMessage))
          .catch(() => showToast("Ошибка копирования", "error"));
      }

      function copyContainerNoToClipboard(containerNo) {
        if (!containerNo) {
          showToast("Нет номера контейнера для копирования", "error");
          return;
        }
        
        navigator.clipboard.writeText(containerNo)
          .then(() => {
            showToast(`Номер контейнера ${containerNo} скопирован в буфер обмена!`);
          })
          .catch((err) => {
            console.error("Ошибка копирования номера контейнера:", err);
            showToast("Ошибка копирования номера контейнера", "error");
          });
      }

      function clearLocalData() {
        localStorage.removeItem("mapato_data");
        localStorage.removeItem("mapato_upload_time");
        window.location.href = "/";
      }

      function goBackToUpload() {
        clearLocalData();
      }



      function updatePackageType(containerNo, rowIndex, value) {
        // Преобразуем rowIndex в число, если это строка
        const numericRowIndex = parseInt(rowIndex, 10);
        
        // Обновляем данные в localStorage
        const savedData = localStorage.getItem("mapato_data");
        if (savedData) {
          const data = JSON.parse(savedData);
          
          if (data.containers && data.containers[containerNo] && data.containers[containerNo][numericRowIndex]) {
            data.containers[containerNo][numericRowIndex]["Вид упаковки "] = value;
            localStorage.setItem("mapato_data", JSON.stringify(data));
            
            // НЕ обновляем итоговые значения, так как вид упаковки не влияет на них
            // Просто обновляем отображение
            generateCalc(data.calc);
            
            showToast(`Вид упаковки изменен на ${value} для товара в контейнере ${containerNo}`);
          } else {
            showToast("Ошибка при обновлении вида упаковки", "error");
          }
        } else {
          showToast("Нет данных для обновления", "error");
        }
      }



      function changeBulkPackageTypeForContainer(containerNo, value) {
        if (!value) return;
        
        // Обновляем данные в localStorage
        const savedData = localStorage.getItem("mapato_data");
        if (savedData) {
          const data = JSON.parse(savedData);
          if (data.containers && data.containers[containerNo]) {
            // Обновляем все товары в этом контейнере
            data.containers[containerNo].forEach(row => {
              row["Вид упаковки "] = value;
            });
            localStorage.setItem("mapato_data", JSON.stringify(data));
            
            // НЕ обновляем итоговые значения, так как вид упаковки не влияет на них
            // Просто обновляем отображение
            generateCalc(data.calc);
          }
        }
        
        // Обновляем UI
        const containerTable = document.querySelector(`[data-container="${containerNo}"]`);
        const packageSelects = containerTable.querySelectorAll(".package-type-select");
        packageSelects.forEach((select) => {
          select.value = value;
        });
        
        const bulkSelect = containerTable.querySelector(".bulk-package-select");
        if (bulkSelect) bulkSelect.value = "";
        showToast(`Вид упаковки изменен на ${value} для контейнера ${containerNo}`);
      }

      function updatePackageInfo(containerNo, rowIndex, value) {
        // Преобразуем rowIndex в число, если это строка
        const numericRowIndex = parseInt(rowIndex, 10);
        
        // Преобразуем value в число
        const numericValue = parseInt(value, 10);
        
        // Обновляем данные в localStorage
        const savedData = localStorage.getItem("mapato_data");
        if (savedData) {
          const data = JSON.parse(savedData);
          
          if (data.containers && data.containers[containerNo] && data.containers[containerNo][numericRowIndex]) {
            data.containers[containerNo][numericRowIndex]["Информация об упаковке (0-БЕЗ, 1 С)"] = numericValue;
            localStorage.setItem("mapato_data", JSON.stringify(data));
            
            showToast(`Информация об упаковке изменена на ${value} для товара в контейнере ${containerNo}`);
          } else {
            showToast("Ошибка при обновлении информации об упаковке", "error");
          }
        } else {
          showToast("Нет данных для обновления", "error");
        }
      }

      function changeBulkPackageInfoForContainer(containerNo, value) {
        if (!value) return;
        
        // Преобразуем value в число
        const numericValue = parseInt(value, 10);
        
        // Обновляем данные в localStorage
        const savedData = localStorage.getItem("mapato_data");
        if (savedData) {
          const data = JSON.parse(savedData);
          if (data.containers && data.containers[containerNo]) {
            // Обновляем все товары в этом контейнере
            data.containers[containerNo].forEach(row => {
              row["Информация об упаковке (0-БЕЗ, 1 С)"] = numericValue;
            });
            localStorage.setItem("mapato_data", JSON.stringify(data));
          }
        }
        
        // Обновляем UI
        const containerTable = document.querySelector(`[data-container="${containerNo}"]`);
        const packageInfoSelects = containerTable.querySelectorAll(".package-info-select");
        packageInfoSelects.forEach((select) => {
          select.value = value;
        });
        
        const bulkSelect = containerTable.querySelector(".bulk-package-info-select");
        if (bulkSelect) bulkSelect.value = "";
        showToast(`Информация об упаковке изменена на ${value} для контейнера ${containerNo}`);
      }

      // Save data to server
      async function saveDataToServer() {
        try {
          const savedData = localStorage.getItem("mapato_data");
          if (!savedData) {
            showToast("Нет данных для сохранения", "error");
            return;
          }

          // Отладочная информация
          const data = JSON.parse(savedData);
          console.log("Отправляем данные:", {
            containers: Object.keys(data.containers || {}),
            sender_name: data.sender_name,
            recipient_name: data.recipient_name,
            sender_address: data.sender_address,
            recipient_address: data.recipient_address,
            invoice: data.invoice,
            date_invoice: data.date_invoice,
            totals: data.totals,
            calc: data.calc
          });

          // Отправляем данные из localStorage на сервер
          // Изменения уже должны быть сохранены в localStorage через updatePackageInfo и updatePackageType
          const response = await fetch('/save', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: savedData
          });

          if (response.ok) {
            const result = await response.json();
            showToast(result.message || "Данные успешно сохранены!", "success");
            
            // Показываем кнопку скачивания если есть URL для скачивания
            if (result.download_url) {
              const downloadBtn = document.getElementById("download-btn");
              downloadBtn.style.display = "inline-flex";
              downloadBtn.onclick = () => {
                window.open(result.download_url, '_blank');
              };
            }
          } else {
            let errorMessage = "Ошибка при сохранении данных";
            try {
              const error = await response.json();
              console.error("Ошибка сервера:", error);
              
              if (response.status === 422) {
                errorMessage = "Ошибка валидации данных. Проверьте структуру данных.";
                if (error.detail) {
                  errorMessage += " Детали: " + JSON.stringify(error.detail);
                }
              } else {
                errorMessage = error.detail || error.error || errorMessage;
              }
            } catch (e) {
              console.error("Не удалось разобрать ошибку:", e);
              errorMessage = `Ошибка ${response.status}: ${response.statusText}`;
            }
            showToast(errorMessage, "error");
          }
        } catch (error) {
          console.error("Ошибка при сохранении:", error);
          showToast("Ошибка при сохранении данных", "error");
        }
      }

      // Функции поиска
      let originalContainerData = null;
      let filteredContainerData = null;

      function initializeSearch() {
        const searchInput = document.getElementById("search-input");
        const clearBtn = document.getElementById("clear-search-btn");
        
        if (searchInput) {
          searchInput.addEventListener("input", handleSearch);
        }
        
        if (clearBtn) {
          clearBtn.addEventListener("click", clearSearch);
        }
      }

      function handleSearch(event) {
        const searchTerm = event.target.value.toLowerCase().trim();
        const clearBtn = document.getElementById("clear-search-btn");
        
        // Показываем/скрываем кнопку очистки
        if (searchTerm) {
          clearBtn.style.display = "block";
        } else {
          clearBtn.style.display = "none";
        }
        
        if (!searchTerm) {
          // Если поиск пустой, показываем все контейнеры
          restoreAllContainers();
          return;
        }
        
        // Сохраняем оригинальные данные при первом поиске
        if (!originalContainerData) {
          const savedData = localStorage.getItem("mapato_data");
          if (savedData) {
            const data = JSON.parse(savedData);
            originalContainerData = data.containers;
          }
        }
        
        // Фильтруем контейнеры
        filterContainers(searchTerm);
      }

      function filterContainers(searchTerm) {
        if (!originalContainerData) return;
        
        filteredContainerData = {};
        
        Object.entries(originalContainerData).forEach(([containerNo, rows]) => {
          const matchingRows = rows.filter(row => {
            // Ищем по различным полям
            return Object.values(row).some(value => {
              if (typeof value === 'string' || typeof value === 'number') {
                return value.toString().toLowerCase().includes(searchTerm);
              }
              return false;
            });
          });
          
          if (matchingRows.length > 0) {
            filteredContainerData[containerNo] = matchingRows;
          }
        });
        
        // Обновляем отображение
        updateContainerDisplay();
      }

      function updateContainerDisplay() {
        const tableContainer = document.querySelector(
          ".bg-white.rounded-lg.shadow-sm.border.border-slate-200.overflow-hidden"
        );
        const tableWrapper = tableContainer.querySelector(".overflow-x-auto");
        
        // Очищаем существующие таблицы
        tableWrapper.innerHTML = "";
        
        // Генерируем новые таблицы с отфильтрованными данными
        if (filteredContainerData && Object.keys(filteredContainerData).length > 0) {
          generateGroupedTables(filteredContainerData);
        } else {
          // Показываем сообщение о том, что ничего не найдено
          tableWrapper.innerHTML = `
            <div class="text-center py-8 text-slate-500">
              <svg class="w-16 h-16 text-slate-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
              <p class="text-lg font-semibold text-slate-600">Ничего не найдено</p>
              <p class="text-slate-500 mt-2">Попробуйте изменить поисковый запрос</p>
            </div>
          `;
        }
      }

      function restoreAllContainers() {
        if (!originalContainerData) return;
        
        filteredContainerData = null;
        
        const tableContainer = document.querySelector(
          ".bg-white.rounded-lg.shadow-sm.border.border-slate-200.overflow-hidden"
        );
        const tableWrapper = tableContainer.querySelector(".overflow-x-auto");
        
        // Очищаем существующие таблицы
        tableWrapper.innerHTML = "";
        
        // Генерируем таблицы с оригинальными данными
        generateGroupedTables(originalContainerData);
      }

      function clearSearch() {
        const searchInput = document.getElementById("search-input");
        const clearBtn = document.getElementById("clear-search-btn");
        
        searchInput.value = "";
        clearBtn.style.display = "none";
        
        restoreAllContainers();
      }

      // Удален обработчик для неиспользуемой кнопки копирования
      document.getElementById("save-btn").addEventListener("click", saveDataToServer);
      
      // Инициализируем поиск после загрузки данных
      fetchData().then(() => {
        initializeSearch();
      });
    </script>
  </body>
</html>

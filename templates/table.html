<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Таблица данных</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              inter: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 font-inter"
  >
    <main class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
      <div
        class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"
      >
        <div
          class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 flex justify-between items-center"
        >
          <h2 class="text-xl font-semibold text-white flex items-center">
            <svg
              class="w-6 h-6 mr-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              ></path>
            </svg>
            Информация об отправителе
          </h2>
          <button
            onclick="goBackToUpload()"
            class="inline-flex items-center gap-2 px-4 py-2 bg-white/100 border border-gray-300 hover:bg-blue-900 hover:text-white/100 text-blue-600 rounded-lg transition-all duration-200 text-sm font-medium"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16l-4-4m0 0l4-4m-4 4h18"
              ></path>
            </svg>
            Загрузить новый файл
          </button>
        </div>
        <!-- Блок основной информации -->
        <div class="p-6 py-4" id="sender-info">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Отправитель -->
            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <div
                  class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center border-2 border-blue-200"
                >
                  <svg
                    class="w-5 h-5 text-blue-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                    ></path>
                  </svg>
                </div>
              </div>
              <div class="flex-1">
                <p class="text-sm font-medium text-slate-500">Отправитель</p>
                <p
                  class="text-sm font-semibold text-slate-900"
                  id="sender-name"
                >
                  Загрузка...
                </p>
              </div>
              <button
                onclick="copySenderName()"
                class="flex-shrink-0 p-2 text-slate-400 border-2 border-gray-300 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors duration-200"
                title="Скопировать отправителя"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                  ></path>
                </svg>
              </button>
            </div>

            <!-- Номер контейнера -->
            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <div
                  class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center border-2 border-green-200"
                >
                  <svg
                    class="w-5 h-5 text-green-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                  </svg>
                </div>
              </div>
              <div class="flex-1">
                <p class="text-sm font-medium text-slate-500">
                  Номер контейнера
                </p>
                <p
                  class="text-sm font-semibold text-slate-900"
                  id="truck-number"
                >
                  Загрузка...
                </p>
              </div>
              <button
                onclick="copyContainerNumber()"
                class="flex-shrink-0 p-2 text-slate-400 border-2 border-gray-300 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors duration-200"
                title="Скопировать номер контейнера"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Блок дополнительной информации -->
        <div class="p-6 py-4 pt-0" id="additional-info">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Получатель -->
            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <div
                  class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center border-2 border-orange-200"
                >
                  <svg
                    class="w-5 h-5 text-orange-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                    ></path>
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                    ></path>
                  </svg>
                </div>
              </div>
              <div class="flex-1">
                <p class="text-sm font-medium text-slate-500">Получатель</p>
                <p
                  class="text-sm font-semibold text-slate-900"
                  id="recipient-name"
                >
                  Загрузка...
                </p>
              </div>
              <button
                onclick="copyRecipientName()"
                class="flex-shrink-0 p-2 text-slate-400 border-2 border-gray-300 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-colors duration-200"
                title="Скопировать получателя"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                  ></path>
                </svg>
              </button>
            </div>

            <!-- Время загрузки документа -->
            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <div
                  class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center border-2 border-purple-200"
                >
                  <svg
                    class="w-5 h-5 text-purple-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                  </svg>
                </div>
              </div>
              <div class="flex-1">
                <p class="text-sm font-medium text-slate-500">
                  Время загрузки документа
                </p>
                <p
                  class="text-sm font-semibold text-slate-900"
                  id="upload-time"
                >
                  Загрузка...
                </p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Блок покупателя -->
        <div class="p-6 py-4 pt-0" id="additional-info-1">
                  <div class="grid grid-cols-1 md:grid-cols-1 gap-6">
                    <!-- Получатель -->
                    <div class="flex items-center space-x-3">
                      <div class="flex-shrink-0">
                        <div
                          class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center border-2 border-red-200"
                        >
                          <svg
                            class="w-5 h-5 text-red-600"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                            ></path>
                          </svg>
                        </div>
                      </div>
                      <div class="flex-1">
                        <p class="text-sm font-medium text-slate-500">Покупатель</p>
                        <p
                          class="text-sm font-semibold text-slate-900"
                          id="buyer-name"
                        >
                          Загрузка...
                        </p>
                      </div>
                      <button
                        onclick="copyBuyerName()"
                        class="flex-shrink-0 p-2 text-slate-400 border-2 border-gray-300 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-colors duration-200"
                        title="Скопировать покупателя"
                      >
                        <svg
                          class="w-5 h-5"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                          ></path>
                        </svg>
                      </button>
                    </div>
        
                  </div>
        </div>

        <!-- Блок итоговых значений -->
        <div
          class="border-t border-slate-400 bg-slate-100 from-slate-50 to-slate-100"
        >
          <div class="px-6 py-4">
            <div class="flex items-center justify-between cursor-pointer hover:bg-slate-200 transition-colors duration-200 rounded-lg p-2 -m-2" onclick="toggleTotalsSection()">
              <div class="flex items-center">
                <button
                  onclick="event.stopPropagation(); toggleTotalsSection()"
                  class="mr-3 p-1 bg-white border-2 border-slate-300 rounded-lg transition-colors duration-200 text-slate-600 hover:text-white hover:bg-slate-600"
                  id="totals-toggle-btn"
                >
                  <svg
                    class="w-5 h-5 transform transition-transform duration-200"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    id="totals-toggle-icon"
                    style="transform: rotate(-90deg)"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    ></path>
                  </svg>
                </button>

                <div
                  class="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center mr-3 border-2 border-emerald-200"
                >
                  <svg
                    class="w-5 h-5 text-emerald-600 "
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                    ></path>
                  </svg>
                </div>
                <h3 class="text-sm font-semibold text-slate-900">
                  Итоговые значения
                </h3>
              </div>

              <!-- Статус схождения данных -->
              <div
                id="totals-status"
                class="flex items-center space-x-3 hidden"
                onclick="event.stopPropagation()"
              >
                <div
                  id="status-badge"
                  class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium shadow-sm"
                >
                  <div id="status-icon" class="w-4 h-4 mr-2">
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M5 13l4 4L19 7"
                      ></path>
                    </svg>
                  </div>
                  <span id="status-text"></span>
                </div>
              </div>
            </div>

            <div id="totals-content" class="hidden mt-4">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-3">
                  <div class="flex items-center mb-3 px-2">
                    <div class="w-4 h-4 bg-emerald-500 rounded mr-2"></div>
                    <h4 class="text-sm font-semibold text-slate-800">
                      Итоговые данные по документу
                    </h4>
                  </div>
                  <div id="totals-summary" class="space-y-2"></div>
                </div>
                <div class="space-y-3">
                  <div class="flex items-center mb-3 px-2">
                    <div class="w-4 h-4 bg-purple-500 rounded mr-2"></div>
                    <h4 class="text-sm font-semibold text-slate-800">
                      Рассчитанные данные
                    </h4>
                  </div>
                  <div id="totals-calc" class="space-y-2"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"
      >
        <div
          class="bg-gradient-to-r from-slate-800 to-slate-900 px-6 py-4 flex justify-between items-center"
        >
          <h2 class="text-xl font-semibold text-white flex items-center">
            <svg
              class="w-6 h-6 mr-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <rect
                x="3"
                y="5"
                width="18"
                height="14"
                rx="2"
                ry="2"
                stroke-width="2"
              />
              <line x1="3" y1="9" x2="21" y2="9" stroke-width="2" />
              <line x1="9" y1="9" x2="9" y2="19" stroke-width="2" />
              <line x1="15" y1="9" x2="15" y2="19" stroke-width="2" />
            </svg>

            Таблица данных
          </h2>
          <button
            id="copy-btn"
            class="inline-flex items-center px-4 py-2 bg-white text-slate-800 text-sm border border-gray-300 font-medium rounded-lg hover:bg-blue-900 hover:text-white/100 transition-colors duration-200 shadow-sm"
          >
            <svg
              class="w-4 h-4 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
              ></path>
            </svg>
            Скопировать
          </button>
        </div>
        <div class="overflow-x-auto">
          <table id="data-table" class="w-full">
            <thead
              id="table-head"
              class="bg-slate-50 border-b border-slate-200"
            ></thead>
            <tbody id="table-body" class="divide-y divide-slate-200"></tbody>
          </table>
        </div>
        <div id="loading-state" class="flex items-center justify-center py-12">
          <div class="flex items-center space-x-3">
            <div
              class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"
            ></div>
            <span class="text-slate-600">Загрузка данных...</span>
          </div>
        </div>
      </div>
    
    </main>
    <!-- уведомление -->
    <div
      id="toast"
      class="fixed top-4 right-4 transform translate-x-full transition-transform duration-300 ease-in-out z-50"
    >
      <div
        class="bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 13l4 4L19 7"
          ></path>
        </svg>
        <span>Таблица скопирована в буфер обмена!</span>
      </div>
    </div>

    <script>
      // Function to format numbers with thousand separators
      function formatNumber(value) {
        // Проверяем, является ли значение числом
        const num = parseFloat(value);
        if (isNaN(num)) {
          return value; // Возвращаем исходное значение, если это не число
        }
        
        // Форматируем число с разделителями тысячников и обязательно 2 знака после запятой
        return num.toLocaleString('ru-RU', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }

      // Toast notification function
      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const toastContent = toast.querySelector("div");

        if (type === "success") {
          toastContent.className =
            "bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2";
        } else if (type === "error") {
          toastContent.className =
            "bg-red-600 text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2";
        }

        toastContent.querySelector("span").textContent = message;
        toast.classList.remove("translate-x-full");

        setTimeout(() => {
          toast.classList.add("translate-x-full");
        }, 500);
      }

      // Main data fetching function
      async function fetchData() {
        try {
          // Загружаем данные из localStorage
          const savedData = localStorage.getItem("mapato_data");

          if (!savedData) {
            // Если данных нет, показываем сообщение и предлагаем загрузить файл
            document.getElementById("loading-state").innerHTML = `
                        <div class="flex flex-col items-center justify-center py-12 space-y-4">
                            <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="text-center">
                                <p class="text-lg font-semibold text-gray-600">Нет загруженных данных</p>
                                <p class="text-gray-500 mt-2">Сначала загрузите файл для обработки</p>
                                <a href="/" class="inline-flex items-center mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    Загрузить файл
                                </a>
                            </div>
                        </div>
                    `;
            return;
          }

          const data = JSON.parse(savedData);
          const uploadTime = localStorage.getItem("mapato_upload_time");

          // Hide loading state
          document.getElementById("loading-state").style.display = "none";

          // Update sender info
          updateSenderInfo(data.sender, data.truck, uploadTime, data.recipient, data.buyer);

          // Generate table
          generateTable(data.containers || data.rows);

          console.log(data.containers || data.rows);

          // Generate totals
          generateTotals(data.totals);

          // Generate Calc
          generateCalc(data.calc);

          console.log("Data loaded successfully from localStorage:", data);
        } catch (error) {
          console.error("Error loading data from localStorage:", error);
          showToast("Ошибка загрузки данных из локального хранилища", "error");

          // Показываем сообщение об ошибке
          document.getElementById("loading-state").innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 space-y-4">
                        <svg class="w-16 h-16 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="text-center">
                            <p class="text-lg font-semibold text-red-600">Ошибка загрузки данных</p>
                            <p class="text-gray-500 mt-2">Возможно, данные повреждены</p>
                            <button onclick="clearLocalData()" class="inline-flex items-center mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Очистить данные
                            </button>
                        </div>
                    </div>
                `;
        }
      }

      // Update sender information
      function updateSenderInfo(sender, truck, uploadTime, recipient, buyer) {
        document.getElementById("sender-name").textContent =
          sender || "Не указан";
        document.getElementById("truck-number").textContent =
          truck || "Не указан";

        // Обновляем получателя, если элемент существует
        const recipientElement = document.getElementById("recipient-name");
        if (recipientElement) {
          recipientElement.textContent = recipient || "Не указан";
        }

        // Обновляем время загрузки, если элемент существует
        if (uploadTime) {
          const time = new Date(uploadTime);
          const timeString = time.toLocaleString("ru-RU", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          });

          const timeElement = document.getElementById("upload-time");
          if (timeElement) {
            timeElement.textContent = timeString;
          }
        }

        // Обновляем покупателя, если элемент существует
        const buyerSection = document.getElementById("additional-info-1");
        if (buyer && buyer.trim() !== "") {
          buyerSection.style.display = "block";
        } else {
          buyerSection.style.display = "none";
        }
        
        const buyerElement = document.getElementById("buyer-name");
        if (buyerElement) {
          buyerElement.textContent = buyer || "Не указан";
        }
      }

      // Generate table headers and rows
      function generateTable(data) {
        const thead = document.getElementById("table-head");
        const tbody = document.getElementById("table-body");

        // Проверяем, является ли data объектом (сгруппированные данные) или массивом (старый формат)
        if (Array.isArray(data)) {
          // Старый формат - массив строк
          if (data.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="100%" class="text-center py-8 text-slate-500">Нет данных для отображения</td></tr>';
            return;
          }
          generateSingleTable(data);
        } else {
          // Новый формат - объект с группированными данными
          generateGroupedTables(data);
        }
      }

      // Генерация одной таблицы (старый формат)
      function generateSingleTable(rows) {
        const thead = document.getElementById("table-head");
        const tbody = document.getElementById("table-body");

        if (rows.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="100%" class="text-center py-8 text-slate-500">Нет данных для отображения</td></tr>';
          return;
        }

        // Показываем общую кнопку копирования для одиночной таблицы
        const generalCopyBtn = document.getElementById("copy-btn");
        if (generalCopyBtn) {
          generalCopyBtn.style.display = "inline-flex";
        }

        // Generate headers
        const headers = Object.keys(rows[0]);
        thead.innerHTML = `
                <tr>
                    ${headers
                      .map(
                        (header) => `
                        <th class="px-6 py-2 text-left text-xs font-semibold text-slate-700 tracking-normal">
                            ${
                              header === "Вид упаковки "
                                ? `
                                <div class="flex flex-col space-y-2">
                                    <span>${header}</span>
                                    <select 
                                        id="bulk-package-select" 
                                        onchange="changeBulkPackageType(this.value)"
                                        class="text-xs bg-white border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    >
                                        <option value="">Выбрать для всех</option>
                                        <option value="CT">CT</option>
                                        <option value="PK">PK</option>
                                        <option value="CS">CS</option>
                                        <option value="PP">PP</option>
                                    </select>
                                </div>
                            `
                                : header
                            }
                        </th>
                    `
                      )
                      .join("")}
                </tr>
            `;

        // Generate rows
        tbody.innerHTML = rows
          .map(
            (row, index) => `
                <tr class="hover:bg-slate-50 transition-colors duration-150 ${
                  index % 2 === 0 ? "bg-white" : "bg-slate-25"
                }">
                    ${Object.entries(row)
                      .map(
                        ([key, value]) => `
                        <td class="px-6 py-1 text-sm text-slate-900 whitespace-nowrap">
                            ${
                              key === "Вид упаковки "
                                ? `
                                <select 
                                    class="package-type-select text-sm bg-white border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full"
                                    onchange="updatePackageType(${index}, this.value)"
                                    data-row-index="${index}"
                                >
                                    <option value="CT" ${
                                      value === "CT" ? "selected" : ""
                                    }>CT</option>
                                    <option value="PK" ${
                                      value === "PK" ? "selected" : ""
                                    }>PK</option>
                                    <option value="CS" ${
                                      value === "CS" ? "selected" : ""
                                    }>CS</option>
                                    <option value="PP" ${
                                      value === "PP" ? "selected" : ""
                                    }>PP</option>
                                </select>
                            `
                                : value
                            }
                        </td>
                    `
                      )
                      .join("")}
                </tr>
            `
          )
          .join("");
      }

      // Генерация таблиц по группам контейнеров
      function generateGroupedTables(containerData) {
        const tableContainer = document.querySelector(
          ".bg-white.rounded-xl.shadow-sm.border.border-slate-200.overflow-hidden:nth-child(2)"
        );

        if (Object.keys(containerData).length === 0) {
          document.getElementById("table-body").innerHTML =
            '<tr><td colspan="100%" class="text-center py-8 text-slate-500">Нет данных для отображения</td></tr>';
          return;
        }

        // Очищаем существующую таблицу
        const tableWrapper = tableContainer.querySelector(".overflow-x-auto");
        tableWrapper.innerHTML = "";

        // Скрываем общую кнопку копирования для группированных данных
        const generalCopyBtn = document.getElementById("copy-btn");
        if (generalCopyBtn) {
          generalCopyBtn.style.display = "none";
        }

        let globalRowIndex = 0;

        // Создаем отдельную таблицу для каждого контейнера
        Object.entries(containerData).forEach(([containerNo, rows]) => {
          if (rows.length === 0) return;

          const headers = Object.keys(rows[0]);

          const tableHtml = `
            <div class="mb-0 border-t border-slate-400 pb-0">
              <div class="flex justify-between items-center px-6 py-2 bg-slate-200 rounded mb-0 cursor-pointer hover:bg-slate-300 transition-colors duration-200" onclick="toggleContainer('${containerNo}')">
                <div class="flex items-center">
                  <button
                    onclick="event.stopPropagation(); toggleContainer('${containerNo}')"
                    class="mr-3 p-1 bg-white border-2 border-slate-300 rounded-lg transition-colors duration-200
         text-slate-600 hover:text-white hover:bg-slate-600"
                    id="toggle-btn-${containerNo}"
                  >
                    <svg class="w-5 h-5 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="toggle-icon-${containerNo}" style="transform: rotate(-90deg);">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </button>
                  <h3 class="text-lg font-semibold text-slate-800">
                    Контейнер ${
                      Object.keys(containerData).indexOf(containerNo) + 1
                    }: ${containerNo}
                    <span class="text-sm font-normal text-slate-600 ml-2">(${
                      rows.length
                    } позиций)</span>
                  </h3>
                </div>
                <div class="flex space-x-2" onclick="event.stopPropagation()">
                  <button
                    onclick="copyContainerNoToClipboard('${containerNo}')"
                    class="inline-flex items-center px-3 py-1 bg-white text-slate-800 text-sm border border-gray-300 font-medium rounded-lg hover:bg-blue-600 hover:text-white transition-colors duration-200 shadow-sm"
                  >
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    Скопировать номер контейнера
                  </button>
                  <button
                    onclick="copyContainerToClipboard('${containerNo}')"
                    class="inline-flex items-center px-3 py-1 bg-white text-slate-800 text-sm border border-gray-300 font-medium rounded-lg hover:bg-blue-600 hover:text-white transition-colors duration-200 shadow-sm"
                  >
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    Скопировать таблицу
                  </button>
                </div>
              </div>
              <div class="overflow-x-auto transition-all duration-300" id="container-content-${containerNo}" style="display: none;">
                <table class="w-full container-table table-fixed" data-container="${containerNo}">
                  <thead class="bg-slate-50 border-b border-slate-200">
                    <tr>
                      ${headers
                        .filter((header) => header !== "Case No")
                        .map(
                          (header) => `
                          <th class="px-2 py-2 text-left text-xs font-semibold text-slate-700 tracking-normal ${
                            header === "Коммерческое описание товара"
                              ? "w-1/4 min-w-0"
                              : "w-auto"
                          }">
                              ${
                                header === "Вид упаковки "
                                  ? `
                                  <div class="flex flex-col space-y-2">
                                      <span>${header}</span>
                                      <select 
                                          class="bulk-package-select" 
                                          data-container="${containerNo}"
                                          onchange="changeBulkPackageTypeForContainer('${containerNo}', this.value)"
                                          class="text-xs bg-white border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      >
                                          <option value="">Выбрать для всех</option>
                                          <option value="CT">CT</option>
                                          <option value="PK">PK</option>
                                          <option value="CS">CS</option>
                                          <option value="PP">PP</option>
                                      </select>
                                  </div>
                              `
                                  : header
                              }
                          </th>
                      `
                        )
                        .join("")}
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-200">
                    ${rows
                      .map(
                        (row, index) => `
                        <tr class="hover:bg-slate-50 transition-colors duration-150 ${
                          index % 2 === 0 ? "bg-white" : "bg-slate-25"
                        }">
                            ${Object.entries(row)
                              .filter(([key, value]) => key !== "Case No")
                              .map(
                                ([key, value]) => `
                                <td class="px-2 py-1 text-sm text-slate-900 ${
                                  key === "Коммерческое описание товара"
                                    ? "min-w-0 relative"
                                    : "whitespace-nowrap"
                                }">
                                    ${
                                      key === "Коммерческое описание товара"
                                        ? `
                                        <div 
                                            class="cursor-pointer overflow-hidden text-ellipsis"
                                            style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; line-height: 1.2em; max-height: 3.6em;"
                                            onclick="toggleTextExpansion(this)"
                                            title="Нажмите для развертывания/свертывания"
                                        >
                                            ${value}
                                        </div>
                                        `
                                        : key === "Вид упаковки "
                                        ? `
                                        <select 
                                            class="package-type-select text-sm bg-white border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full"
                                            onchange="updatePackageType(${globalRowIndex}, this.value)"
                                            data-row-index="${globalRowIndex}"
                                            data-container="${containerNo}"
                                        >
                                            <option value="CT" ${
                                              value === "CT" ? "selected" : ""
                                            }>CT</option>
                                            <option value="PK" ${
                                              value === "PK" ? "selected" : ""
                                            }>PK</option>
                                            <option value="CS" ${
                                              value === "CS" ? "selected" : ""
                                            }>CS</option>
                                            <option value="PP" ${
                                              value === "PP" ? "selected" : ""
                                            }>PP</option>
                                        </select>
                                    `
                                        : value
                                    }
                                </td>
                            `
                              )
                              .join("")}
                        </tr>
                    `
                      )
                      .join("")}
                  </tbody>
                </table>
              </div>
            </div>
          `;

          globalRowIndex += rows.length;
          tableWrapper.insertAdjacentHTML("beforeend", tableHtml);
        });

        // Добавляем функцию для сворачивания/разворачивания контейнеров
        window.toggleContainer = function (containerNo) {
          const content = document.getElementById(
            `container-content-${containerNo}`
          );
          const icon = document.getElementById(`toggle-icon-${containerNo}`);

          if (content.style.display === "none") {
            content.style.display = "block";
            icon.style.transform = "rotate(0deg)";
          } else {
            content.style.display = "none";
            icon.style.transform = "rotate(-90deg)";
          }
        };
      }

      // Generate totals summary
      function generateTotals(totals) {
        const totalsNames = {
          total_quantity: "Кол-во мест",
          total_weight: "Вес брутто",
          total_amount: "Сумма",
        };

        const totalsContainer = document.getElementById("totals-summary");
        totalsContainer.innerHTML = `
                ${Object.entries(totals)
                  .map(
                    ([key, value]) => `
                    <div id="total-${key}" class="flex justify-between items-center py-2 px-3 bg-slate-50 rounded-lg">
                        <span class="text-sm font-medium text-slate-600">${
                          totalsNames[key] || key
                        }</span>
                        <span class="text-sm font-bold text-slate-900">${formatNumber(value)}</span>
                    </div>
                `
                  )
                  .join("")}
            `;
      }

      // Generate summary for calc
      function generateCalc(calc) {
        const calcNames = {
          calc_quantity: "Кол-во мест",
          calc_weight: "Вес брутто",
          calc_amount: "Сумма",
        };

        const calcContainer = document.getElementById("totals-calc");
        calcContainer.innerHTML = `
                ${Object.entries(calc)
                  .map(
                    ([key, value]) => `
                    <div id="calc-${key}" class="flex justify-between items-center py-2 px-3 bg-slate-50 rounded-lg">
                        <span class="text-sm font-medium text-slate-600">${
                          calcNames[key] || key
                        }</span>
                        <span class="text-sm font-bold text-slate-900">${formatNumber(value)}</span>
                    </div>
                `
                  )
                  .join("")}
            `;

        compareValues(calc);
      }

      function compareValues(calc) {
        const savedData = localStorage.getItem("mapato_data");
        if (!savedData) return;

        const data = JSON.parse(savedData);
        const totals = data.totals;

        let hasDiscrepancies = false;

        // Compare values and highlight discrepancies
        const comparisons = [
          {
            totalKey: "total_quantity",
            calcKey: "calc_quantity",
            name: "Кол-во мест",
          },
          {
            totalKey: "total_weight",
            calcKey: "calc_weight",
            name: "Вес брутто",
          },
          { totalKey: "total_amount", 
            calcKey: "calc_amount", 
            name: "Сумма" 
          },
        ];

        comparisons.forEach((comp) => {
          const totalValue = parseFloat(totals[comp.totalKey]);
          const calcValue = parseFloat(calc[comp.calcKey]);
          const isMatch = totalValue === calcValue;

          if (!isMatch) {
            hasDiscrepancies = true;
            // Highlight discrepant values
            const totalElement = document.getElementById(
              `total-${comp.totalKey}`
            );
            const calcElement = document.getElementById(`calc-${comp.calcKey}`);

            if (totalElement) {
              totalElement.classList.remove("bg-slate-50");
              totalElement.classList.add(
                "bg-red-100",
                "border",
                "border-red-300"
              );
            }
            if (calcElement) {
              calcElement.classList.remove("bg-slate-50");
              calcElement.classList.add(
                "bg-red-100",
                "border",
                "border-red-300"
              );
            }
          }

          if (isMatch) {
            // Highlight matching values
            const totalElement = document.getElementById(
              `total-${comp.totalKey}`
            );
            const calcElement = document.getElementById(`calc-${comp.calcKey}`);

            if (totalElement) {
              totalElement.classList.remove("bg-slate-50");
              totalElement.classList.add(
                "bg-green-100",
                "border",
                "border-green-500"
              );
            }
            if (calcElement) {
              calcElement.classList.remove("bg-slate-50");
              calcElement.classList.add(
                "bg-green-100",
                "border",
                "border-green-500"
              );
            }
          }
        });

        // Update status indicator
        updateTotalsStatus(hasDiscrepancies);
      }

      // Update totals status indicator
      function updateTotalsStatus(hasDiscrepancies) {
        const statusElement = document.getElementById("totals-status");
        const statusBadge = document.getElementById("status-badge");
        const statusIcon = document.getElementById("status-icon");
        const statusText = document.getElementById("status-text");

        if (hasDiscrepancies) {
          statusElement.classList.remove("hidden");
          statusBadge.className =
            "inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium shadow-sm bg-red-100 border-2 border-red-300 text-red-800 animate-pulse-fast";
          statusIcon.innerHTML = `
            <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
          `;
          statusText.textContent = "Несхождение данных";
        } else {
          statusElement.classList.remove("hidden");
          statusBadge.className =
            "inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium shadow-sm bg-green-100 border-2 border-green-300 text-green-800";
          statusIcon.innerHTML = `
            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          `;
          statusText.textContent = "Схождение данных";
        }
      }

      // Toggle totals section
      function toggleTotalsSection() {
        const content = document.getElementById("totals-content");
        const icon = document.getElementById("totals-toggle-icon");

        if (content.classList.contains("hidden")) {
          content.classList.remove("hidden");
          icon.style.transform = "rotate(0deg)";
        } else {
          content.classList.add("hidden");
          icon.style.transform = "rotate(-90deg)";
        }
      }

      // Copy table to clipboard
      function copyTableToClipboard() {
        let text = "";

        // Проверяем, есть ли группированные таблицы
        const containerTables = document.querySelectorAll(".container-table");

        // Копируем таблицу
        const table = document.getElementById("data-table");
        if (table) {
          // Старый формат - одна таблица
          const table = document.getElementById("data-table");
          if (table) {
            table.querySelectorAll("tbody tr").forEach((row) => {
              const cells = [...row.querySelectorAll("td")].map((td) => {
                const select = td.querySelector("select.package-type-select");
                if (select) {
                  return select.value;
                } else {
                  return td.textContent.trim();
                }
              });
              text += cells.join("\t") + "\n";
            });
          }
        }

        text = text.replace(/\./g, ","); // Заменить все точки на запятые

        navigator.clipboard
          .writeText(text)
          .then(() => {
            showToast("Таблица скопирована в буфер обмена!");
          })
          .catch((err) => {
            console.error("Ошибка копирования:", err);
            showToast("Ошибка копирования данных", "error");
          });
      }

      // Copy specific container table to clipboard
      function copyContainerToClipboard(containerNo) {
        const containerTable = document.querySelector(
          `[data-container="${containerNo}"]`
        );

        if (!containerTable) {
          showToast("Контейнер не найден", "error");
          return;
        }

        //let text = `Контейнер: ${containerNo}\n`;
        let text = "";

        // Get rows for this container
        containerTable.querySelectorAll("tbody tr").forEach((row) => {
          const cells = [...row.querySelectorAll("td")].map((td) => {
            // Проверяем, есть ли в ячейке селект
            const select = td.querySelector("select.package-type-select");
            if (select) {
              // Если есть селект, берем его выбранное значение
              return select.value;
            } else {
              // Иначе берем обычный текст
              return td.textContent.trim();
            }
          });
          text += cells.join("\t") + "\n";
        });

        text = text.replace(/\./g, ","); // Заменить все точки на запятые

        navigator.clipboard
          .writeText(text)
          .then(() => {
            showToast(`Контейнер ${containerNo} скопирован в буфер обмена!`);
          })
          .catch((err) => {
            console.error("Ошибка копирования:", err);
            showToast("Ошибка копирования данных", "error");
          });
      }

      // Copy sender name to clipboard
      function copySenderName() {
        const senderName = document.getElementById("sender-name").textContent;
        if (
          senderName &&
          senderName !== "Загрузка..." &&
          senderName !== "Не указан"
        ) {
          navigator.clipboard
            .writeText(senderName)
            .then(() => {
              showToast("Отправитель скопирован в буфер обмена!");
            })
            .catch((err) => {
              console.error("Ошибка копирования:", err);
              showToast("Ошибка копирования отправителя", "error");
            });
        } else {
          showToast("Нет данных для копирования", "error");
        }
      }

      // Copy container number to clipboard
      function copyContainerNumber() {
        const containerNumber =
          document.getElementById("truck-number").textContent;
        if (
          containerNumber &&
          containerNumber !== "Загрузка..." &&
          containerNumber !== "Не указан"
        ) {
          navigator.clipboard
            .writeText(containerNumber)
            .then(() => {
              showToast("Номер контейнера скопирован в буфер обмена!");
            })
            .catch((err) => {
              console.error("Ошибка копирования:", err);
              showToast("Ошибка копирования номера контейнера", "error");
            });
        } else {
          showToast("Нет данных для копирования", "error");
        }
      }

      // Copy specific container number to clipboard
      function copyContainerNoToClipboard(containerNo) {
        if (containerNo && containerNo !== "Не указан") {
          navigator.clipboard
            .writeText(containerNo)
            .then(() => {
              showToast(
                `Номер контейнера ${containerNo} скопирован в буфер обмена!`
              );
            })
            .catch((err) => {
              console.error("Ошибка копирования:", err);
              showToast("Ошибка копирования номера контейнера", "error");
            });
        } else {
          showToast("Нет данных для копирования", "error");
        }
      }

      // Copy recipient name to clipboard
      function copyRecipientName() {
        const recipientName =
          document.getElementById("recipient-name").textContent;
        if (
          recipientName &&
          recipientName !== "Загрузка..." &&
          recipientName !== "Не указан"
        ) {
          navigator.clipboard
            .writeText(recipientName)
            .then(() => {
              showToast("Получатель скопирован в буфер обмена!");
            })
            .catch((err) => {
              console.error("Ошибка копирования:", err);
              showToast("Ошибка копирования получателя", "error");
            });
        } else {
          showToast("Нет данных для копирования", "error");
        }
      }

      // Copy buyer name to clipboard
      function copyBuyerName() {
        const buyerName = document.getElementById("buyer-name").textContent;
        if (buyerName && buyerName !== "Загрузка..." && buyerName !== "Не указан") {
          navigator.clipboard.writeText(buyerName).then(() => {
            showToast("Покупатель скопирован в буфер обмена!");
          });
        } else {
          showToast("Нет данных для копирования", "error");
        }
      }

      // Clear localStorage data
      function clearLocalData() {
        localStorage.removeItem("mapato_data");
        localStorage.removeItem("mapato_upload_time");
      }

      // Go back to upload page and clear local storage
      function goBackToUpload() {
        // Очищаем localStorage от данных текущего документа
        localStorage.removeItem("mapato_data");
        localStorage.removeItem("mapato_upload_time");
        // Переходим на страницу загрузки
        window.location.href = "/";
      }

      // Add clear data button to the interface
      function addClearDataButton() {
        const buttonContainer = document.querySelector(
          ".bg-gradient-to-r.from-slate-800 .flex.justify-between"
        );
        if (
          buttonContainer &&
          !buttonContainer.querySelector(".clear-data-btn")
        ) {
          const buttonsHtml = `
                    <a href="/" class="inline-flex items-center px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-sm ml-3">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Загрузить новый
                    </a>
                    <button onclick="clearLocalData()" class="clear-data-btn inline-flex items-center px-3 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition-colors duration-200 shadow-sm ml-3">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Очистить
                    </button>
                `;
          buttonContainer.insertAdjacentHTML("beforeend", buttonsHtml);
        }
      }

      // Package type management functions
      function changeBulkPackageType(value) {
        if (!value) return; // Если выбрано "Выбрать для всех", ничего не делаем

        // Обновляем все селекты строк
        const packageSelects = document.querySelectorAll(
          ".package-type-select"
        );
        packageSelects.forEach((select) => {
          select.value = value;
          const rowIndex = parseInt(select.getAttribute("data-row-index"));
          updatePackageTypeInData(rowIndex, value);
        });

        // Сбрасываем выбор в bulk селекте
        document.getElementById("bulk-package-select").value = "";

        showToast(`Вид упаковки изменен на ${value} для всех товаров`);
      }

      // Функция для смены упаковки для конкретного контейнера
      function changeBulkPackageTypeForContainer(containerNo, value) {
        if (!value) return;

        // Обновляем все селекты в конкретном контейнере
        const containerTable = document.querySelector(
          `[data-container="${containerNo}"]`
        );
        const packageSelects = containerTable.querySelectorAll(
          ".package-type-select"
        );

        packageSelects.forEach((select) => {
          select.value = value;
          const rowIndex = parseInt(select.getAttribute("data-row-index"));
          updatePackageTypeInData(rowIndex, value);
        });

        // Сбрасываем выбор в bulk селекте для этого контейнера
        const bulkSelect = containerTable.querySelector(".bulk-package-select");
        if (bulkSelect) {
          bulkSelect.value = "";
        }

        showToast(
          `Вид упаковки изменен на ${value} для контейнера ${containerNo}`
        );
      }

      function updatePackageType(rowIndex, value) {
        updatePackageTypeInData(rowIndex, value);
        showToast(
          `Вид упаковки изменен на ${value} для строки ${rowIndex + 1}`
        );
      }

      function updatePackageTypeInData(rowIndex, value) {
        // Обновляем данные в localStorage
        const savedData = localStorage.getItem("mapato_data");
        if (savedData) {
          const data = JSON.parse(savedData);
          if (data.rows && data.rows[rowIndex]) {
            data.rows[rowIndex]["Вид упаковки "] = value;
            localStorage.setItem("mapato_data", JSON.stringify(data));
          }
        }
      }

      // Event listeners
      document
        .getElementById("copy-btn")
        .addEventListener("click", copyTableToClipboard);

      // Initialize
      fetchData().then(() => {
        // Добавляем кнопку очистки данных если данные загружены
        const savedData = localStorage.getItem("mapato_data");
        if (savedData) {
          addClearDataButton();
        }
      });
    </script>
  </body>
</html>
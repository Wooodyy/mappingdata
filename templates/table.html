<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Таблица данных</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              inter: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 font-inter"
  >
    <main class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
      <div
        class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"
      >
        <div
          class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 flex justify-between items-center"
        >
          <h2 class="text-xl font-semibold text-white flex items-center">
            <svg
              class="w-6 h-6 mr-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              ></path>
            </svg>
            Информация об отправителе
          </h2>
          <button
            onclick="goBackToUpload()"
            class="inline-flex items-center gap-2 px-4 py-2 bg-white/100 hover:bg-blue-900 hover:text-white/100 text-blue-600 rounded-lg transition-all duration-200 text-sm font-medium"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16l-4-4m0 0l4-4m-4 4h18"
              ></path>
            </svg>
            Загрузить новый файл
          </button>
        </div>
        <div class="p-6" id="sender-info">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <div
                  class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center"
                >
                  <svg
                    class="w-5 h-5 text-blue-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                    ></path>
                  </svg>
                </div>
              </div>
              <div class="flex-1">
                <p class="text-sm font-medium text-slate-500">Отправитель</p>
                <p
                  class="text-lg font-semibold text-slate-900"
                  id="sender-name"
                >
                  Загрузка...
                </p>
              </div>
              <button
                onclick="copySenderName()"
                class="flex-shrink-0 p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors duration-200"
                title="Скопировать отправителя"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                  ></path>
                </svg>
              </button>
            </div>
            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <div
                  class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center"
                >
                  <svg
                    class="w-5 h-5 text-green-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                  </svg>
                </div>
              </div>
              <div class="flex-1">
                <p class="text-sm font-medium text-slate-500">
                  Номер контейнера
                </p>
                <p
                  class="text-lg font-semibold text-slate-900"
                  id="truck-number"
                >
                  Загрузка...
                </p>
              </div>
              <button
                onclick="copyContainerNumber()"
                class="flex-shrink-0 p-2 text-slate-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors duration-200"
                title="Скопировать номер контейнера"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div
        class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"
      >
        <div
          class="bg-gradient-to-r from-slate-800 to-slate-900 px-6 py-4 flex justify-between items-center"
        >
          <h2 class="text-xl font-semibold text-white flex items-center">
            <svg
              class="w-6 h-6 mr-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 002 2m0 0v10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h2a2 2 0 002-2"
              ></path>
            </svg>
            Таблица данных
          </h2>
          <button
            id="copy-btn"
            class="inline-flex items-center px-4 py-2 bg-white text-slate-800 text-sm font-medium rounded-lg hover:bg-blue-900 hover:text-white/100 transition-colors duration-200 shadow-sm"
          >
            <svg
              class="w-4 h-4 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
              ></path>
            </svg>
            Скопировать
          </button>
        </div>
        <div class="overflow-x-auto">
          <table id="data-table" class="w-full">
            <thead
              id="table-head"
              class="bg-slate-50 border-b border-slate-200"
            ></thead>
            <tbody id="table-body" class="divide-y divide-slate-200"></tbody>
          </table>
        </div>
        <div id="loading-state" class="flex items-center justify-center py-12">
          <div class="flex items-center space-x-3">
            <div
              class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"
            ></div>
            <span class="text-slate-600">Загрузка данных...</span>
          </div>
        </div>
      </div>

      <div
        class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"
      >
        <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 px-6 py-4">
          <h2 class="text-xl font-semibold text-white flex items-center">
            <svg
              class="w-6 h-6 mr-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"
              ></path>
            </svg>
            Итоговые значения
          </h2>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="space-y-3">
              <div class="flex items-center mb-3">
                <div class="w-2 h-2 bg-emerald-500 rounded-full mr-2"></div>
                <h3 class="text-sm font-semibold text-slate-700">
                  Итоговые по документу
                </h3>
              </div>
              <div id="totals-summary" class="space-y-2"></div>
            </div>
            <div class="space-y-3">
              <div class="flex items-center mb-3">
                <div class="w-2 h-2 bg-purple-500 rounded-full mr-2"></div>
                <h3 class="text-sm font-semibold text-slate-700">Расчетные</h3>
              </div>
              <div id="totals-calc" class="space-y-2"></div>
            </div>
            <div class="space-y-3">
              <div class="flex items-center mb-3">
                <div class="w-2 h-2 bg-slate-400 rounded-full mr-2"></div>
                <h3 class="text-sm font-semibold text-slate-700">
                  Статус схождения
                </h3>
              </div>
              <div id="comparison-result" class="space-y-2"></div>
            </div>
          </div>
          <div
            id="discrepancy-alert"
            class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg hidden"
          >
            <div class="flex items-center">
              <svg
                class="w-4 h-4 text-red-500 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              <span class="text-sm font-medium text-red-800"
                >Несхождение данных, проверьте исходные данные</span
              >
            </div>
          </div>
        </div>
      </div>
    </main>

    <div
      id="toast"
      class="fixed top-4 right-4 transform translate-x-full transition-transform duration-300 ease-in-out z-50"
    >
      <div
        class="bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 13l4 4L19 7"
          ></path>
        </svg>
        <span>Таблица скопирована в буфер обмена!</span>
      </div>
    </div>

    <script>
      // Toast notification function
      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const toastContent = toast.querySelector("div");

        if (type === "success") {
          toastContent.className =
            "bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2";
        } else if (type === "error") {
          toastContent.className =
            "bg-red-600 text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2";
        }

        toastContent.querySelector("span").textContent = message;
        toast.classList.remove("translate-x-full");

        setTimeout(() => {
          toast.classList.add("translate-x-full");
        }, 500);
      }

      // Main data fetching function
      async function fetchData() {
        try {
          // Загружаем данные из localStorage
          const savedData = localStorage.getItem("mapato_data");

          if (!savedData) {
            // Если данных нет, показываем сообщение и предлагаем загрузить файл
            document.getElementById("loading-state").innerHTML = `
                        <div class="flex flex-col items-center justify-center py-12 space-y-4">
                            <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="text-center">
                                <p class="text-lg font-semibold text-gray-600">Нет загруженных данных</p>
                                <p class="text-gray-500 mt-2">Сначала загрузите файл для обработки</p>
                                <a href="/" class="inline-flex items-center mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    Загрузить файл
                                </a>
                            </div>
                        </div>
                    `;
            return;
          }

          const data = JSON.parse(savedData);
          const uploadTime = localStorage.getItem("mapato_upload_time");

          // Hide loading state
          document.getElementById("loading-state").style.display = "none";

          // Update sender info
          updateSenderInfo(data.sender, data.truck, uploadTime);

          // Generate table
          generateTable(data.rows);

          // Generate totals
          generateTotals(data.totals);

          // Generate Calc
          generateCalc(data.calc);

          console.log("Data loaded successfully from localStorage:", data);
        } catch (error) {
          console.error("Error loading data from localStorage:", error);
          showToast("Ошибка загрузки данных из локального хранилища", "error");

          // Показываем сообщение об ошибке
          document.getElementById("loading-state").innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 space-y-4">
                        <svg class="w-16 h-16 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="text-center">
                            <p class="text-lg font-semibold text-red-600">Ошибка загрузки данных</p>
                            <p class="text-gray-500 mt-2">Возможно, данные повреждены</p>
                            <button onclick="clearLocalData()" class="inline-flex items-center mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Очистить данные
                            </button>
                        </div>
                    </div>
                `;
        }
      }

      // Update sender information
      function updateSenderInfo(sender, truck, uploadTime) {
        document.getElementById("sender-name").textContent =
          sender || "Не указан";
        document.getElementById("truck-number").textContent =
          truck || "Не указан";

        // Добавляем информацию о времени загрузки если есть
        if (uploadTime) {
          const time = new Date(uploadTime);
          const timeString = time.toLocaleString("ru-RU", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          });

          // Добавляем информацию о времени загрузки под информацией о контейнере
          const senderInfo = document.getElementById("sender-info");
          const existingTimeInfo =
            senderInfo.querySelector(".upload-time-info");
          if (!existingTimeInfo) {
            const timeInfoHtml = `
                <div class="col-span-full upload-time-info ">
                   <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                            <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-slate-500">Отправитель</p>
                            <p class="text-lg font-semibold text-slate-900" id="sender-name">Загрузка...</p>
                        </div>
                        <button onclick="copySenderName()" class="flex-shrink-0 p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors duration-200" title="Скопировать отправителя">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                            </div>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-slate-500">Время загрузки</p>
                            <p class="text-lg font-semibold text-slate-900" id="loading-time">${timeString}</p>
                        </div>
                    </div>
                            <div class="flex items-center space-x-3 mt-4 pt-4 border-t border-gray-200">
                                <div class="flex-shrink-0">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-slate-500">Время загрузки</p>
                                    <p class="text-lg font-semibold text-slate-900">${timeString}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
            senderInfo
              .querySelector(".grid")
              .insertAdjacentHTML("beforeend", timeInfoHtml);
          }
        }
      }

      // Generate table headers and rows
      function generateTable(rows) {
        const thead = document.getElementById("table-head");
        const tbody = document.getElementById("table-body");

        if (rows.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="100%" class="text-center py-8 text-slate-500">Нет данных для отображения</td></tr>';
          return;
        }

        // Generate headers
        const headers = Object.keys(rows[0]);
        thead.innerHTML = `
                <tr>
                    ${headers
                      .map(
                        (header) => `
                        <th class="px-6 py-1 text-left text-xs font-semibold text-slate-700 tracking-normal">
                            ${header}
                        </th>
                    `
                      )
                      .join("")}
                </tr>
            `;

        // Generate rows
        tbody.innerHTML = rows
          .map(
            (row, index) => `
                <tr class="hover:bg-slate-50 transition-colors duration-150 ${
                  index % 2 === 0 ? "bg-white" : "bg-slate-25"
                }">
                    ${Object.values(row)
                      .map(
                        (value) => `
                        <td class="px-6 py-4 text-sm text-slate-900 whitespace-nowrap">
                            ${value}
                        </td>
                    `
                      )
                      .join("")}
                </tr>
            `
          )
          .join("");
      }

      // Generate totals summary
      function generateTotals(totals) {
        const totalsNames = {
          total_quantity: "Кол-во мест",
          total_weight: "Вес брутто",
          total_amount: "Сумма",
        };

        const totalsContainer = document.getElementById("totals-summary");
        totalsContainer.innerHTML = `
                ${Object.entries(totals)
                  .map(
                    ([key, value]) => `
                    <div id="total-${key}" class="flex justify-between items-center py-2 px-3 bg-slate-50 rounded-lg">
                        <span class="text-sm font-medium text-slate-600">${
                          totalsNames[key] || key
                        }</span>
                        <span class="text-sm font-bold text-slate-900">${value}</span>
                    </div>
                `
                  )
                  .join("")}
            `;
      }

      // Generate summary for calc
      function generateCalc(calc) {
        const calcNames = {
          calc_quantity: "Кол-во мест",
          calc_weight: "Вес брутто",
          calc_amount: "Сумма",
        };

        const calcContainer = document.getElementById("totals-calc");
        calcContainer.innerHTML = `
                ${Object.entries(calc)
                  .map(
                    ([key, value]) => `
                    <div id="calc-${key}" class="flex justify-between items-center py-2 px-3 bg-slate-50 rounded-lg">
                        <span class="text-sm font-medium text-slate-600">${
                          calcNames[key] || key
                        }</span>
                        <span class="text-sm font-bold text-slate-900">${value}</span>
                    </div>
                `
                  )
                  .join("")}
            `;

        compareValues(calc);
      }

      function compareValues(calc) {
        const savedData = localStorage.getItem("mapato_data");
        if (!savedData) return;

        const data = JSON.parse(savedData);
        const totals = data.totals;

        const comparisonResult = document.getElementById("comparison-result");
        const discrepancyAlert = document.getElementById("discrepancy-alert");

        let hasDiscrepancies = false;
        let statusHtml = "";

        // Compare values and highlight discrepancies
        const comparisons = [
          {
            totalKey: "total_quantity",
            calcKey: "calc_quantity",
            name: "Кол-во мест",
          },
          {
            totalKey: "total_weight",
            calcKey: "calc_weight",
            name: "Вес брутто",
          },
          { totalKey: "total_amount", calcKey: "calc_amount", name: "Сумма" },
        ];

        comparisons.forEach((comp) => {
          const totalValue = parseFloat(totals[comp.totalKey]);
          const calcValue = parseFloat(calc[comp.calcKey]);
          const isMatch = totalValue === calcValue;

          if (!isMatch) {
            hasDiscrepancies = true;
            // Highlight discrepant values
            const totalElement = document.getElementById(
              `total-${comp.totalKey}`
            );
            const calcElement = document.getElementById(`calc-${comp.calcKey}`);

            if (totalElement) {
              totalElement.classList.remove("bg-slate-50");
              totalElement.classList.add(
                "bg-red-100",
                "border",
                "border-red-200"
              );
            }
            if (calcElement) {
              calcElement.classList.remove("bg-slate-50");
              calcElement.classList.add(
                "bg-red-100",
                "border",
                "border-red-200"
              );
            }
          }

          // Create status indicator
          statusHtml += `
                    <div class="flex justify-between items-center py-2 px-3 ${
                      isMatch ? "bg-green-50" : "bg-red-50"
                    } rounded-lg">
                        <span class="text-sm font-medium text-slate-600">${
                          comp.name
                        }</span>
                        <div class="flex items-center">
                            ${
                              isMatch
                                ? '<svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
                                : '<svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>'
                            }
                        </div>
                    </div>
                `;
        });

        comparisonResult.innerHTML = statusHtml;

        // Show/hide compact discrepancy alert
        if (hasDiscrepancies) {
          discrepancyAlert.classList.remove("hidden");
        } else {
          discrepancyAlert.classList.add("hidden");
        }
      }

      // Copy table to clipboard
      function copyTableToClipboard() {
        const table = document.getElementById("data-table");
        let text = "";

        // Get headers
        //const headers = [...table.querySelectorAll("thead th")].map(th => th.textContent.trim());
        //text += headers.join("\t") + "\n";

        // Get rows
        table.querySelectorAll("tbody tr").forEach((row) => {
          const cells = [...row.querySelectorAll("td")].map((td) =>
            td.textContent.trim()
          );
          text += cells.join("\t") + "\n";
        });

        text = text.replace(/\./g, ","); // Заменить все точки на запятые

        navigator.clipboard
          .writeText(text)
          .then(() => {
            showToast("Таблица скопирована в буфер обмена!");
          })
          .catch((err) => {
            console.error("Ошибка копирования:", err);
            showToast("Ошибка копирования данных", "error");
          });
      }

      // Copy sender name to clipboard
      function copySenderName() {
        const senderName = document.getElementById("sender-name").textContent;
        if (
          senderName &&
          senderName !== "Загрузка..." &&
          senderName !== "Не указан"
        ) {
          navigator.clipboard
            .writeText(senderName)
            .then(() => {
              showToast("Отправитель скопирован в буфер обмена!");
            })
            .catch((err) => {
              console.error("Ошибка копирования:", err);
              showToast("Ошибка копирования отправителя", "error");
            });
        } else {
          showToast("Нет данных для копирования", "error");
        }
      }

      // Copy container number to clipboard
      function copyContainerNumber() {
        const containerNumber =
          document.getElementById("truck-number").textContent;
        if (
          containerNumber &&
          containerNumber !== "Загрузка..." &&
          containerNumber !== "Не указан"
        ) {
          navigator.clipboard
            .writeText(containerNumber)
            .then(() => {
              showToast("Номер контейнера скопирован в буфер обмена!");
            })
            .catch((err) => {
              console.error("Ошибка копирования:", err);
              showToast("Ошибка копирования номера контейнера", "error");
            });
        } else {
          showToast("Нет данных для копирования", "error");
        }
      }

      // Clear localStorage data
      function clearLocalData() {
        localStorage.removeItem("mapato_data");
        localStorage.removeItem("mapato_upload_time");
      }

      // Go back to upload page and clear local storage
      function goBackToUpload() {
        // Очищаем localStorage от данных текущего документа
        localStorage.removeItem("mapato_data");
        localStorage.removeItem("mapato_upload_time");
      }

      // Add clear data button to the interface
      function addClearDataButton() {
        const buttonContainer = document.querySelector(
          ".bg-gradient-to-r.from-slate-800 .flex.justify-between"
        );
        if (
          buttonContainer &&
          !buttonContainer.querySelector(".clear-data-btn")
        ) {
          const buttonsHtml = `
                    <a href="/" class="inline-flex items-center px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-sm ml-3">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Загрузить новый
                    </a>
                    <button onclick="clearLocalData()" class="clear-data-btn inline-flex items-center px-3 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition-colors duration-200 shadow-sm ml-3">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Очистить
                    </button>
                `;
          buttonContainer.insertAdjacentHTML("beforeend", buttonsHtml);
        }
      }

      // Event listeners
      document
        .getElementById("copy-btn")
        .addEventListener("click", copyTableToClipboard);

      // Initialize
      fetchData().then(() => {
        // Добавляем кнопку очистки данных если данные загружены
        const savedData = localStorage.getItem("mapato_data");
        if (savedData) {
          addClearDataButton();
        }
      });
    </script>
  </body>
</html>

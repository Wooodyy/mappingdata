<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Таблица данных</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              inter: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 font-inter">
    <main class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
      <div
        class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"
      >
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 flex justify-between items-center">
          <h2 class="text-xl font-semibold text-white flex items-center">
            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            Информация об отправителе
          </h2>
          <button onclick="goBackToUpload()" class="inline-flex items-center gap-2 px-4 py-2 bg-white/100 border border-gray-300 hover:bg-blue-900 hover:text-white/100 text-blue-600 rounded-lg transition-all duration-200 text-sm font-medium">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
            </svg>
            Загрузить новый файл
          </button>
        </div>
        <div class="p-6 py-4" id="sender-info">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center border-2 border-blue-200">
                  <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                </div>
              </div>
              <div class="flex-1">
                <p class="text-sm font-medium text-slate-500">Отправитель</p>
                <p class="text-sm font-semibold text-slate-900" id="sender-name">Загрузка...</p>
              </div>
              <button onclick="copySenderName()" class="flex-shrink-0 p-2 text-slate-400 border-2 border-gray-300 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors duration-200" title="Скопировать отправителя">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
              </button>
            </div>

            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center border-2 border-green-200">
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
              </div>
              <div class="flex-1">
                <p class="text-sm font-medium text-slate-500">Номер контейнера</p>
                <p class="text-sm font-semibold text-slate-900" id="truck-number">Загрузка...</p>
              </div>
              <button onclick="copyContainerNumber()" class="flex-shrink-0 p-2 text-slate-400 border-2 border-gray-300 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors duration-200" title="Скопировать номер контейнера">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <div class="p-6 py-4 pt-0" id="additional-info">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center border-2 border-orange-200">
                  <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                </div>
              </div>
              <div class="flex-1">
                <p class="text-sm font-medium text-slate-500">Получатель</p>
                <p class="text-sm font-semibold text-slate-900" id="recipient-name">Загрузка...</p>
              </div>
              <button onclick="copyRecipientName()" class="flex-shrink-0 p-2 text-slate-400 border-2 border-gray-300 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-colors duration-200" title="Скопировать получателя">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
              </button>
            </div>

            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center border-2 border-purple-200">
                  <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
              </div>
              <div class="flex-1">
                <p class="text-sm font-medium text-slate-500">Время загрузки документа</p>
                <p class="text-sm font-semibold text-slate-900" id="upload-time">Загрузка...</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="p-6 py-4 pt-0" id="additional-info-1">
          <div class="grid grid-cols-1 md:grid-cols-1 gap-6">
            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center border-2 border-red-200">
                  <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                </div>
              </div>
              <div class="flex-1">
                <p class="text-sm font-medium text-slate-500">Покупатель</p>
                <p class="text-sm font-semibold text-slate-900" id="buyer-name">Загрузка...</p>
              </div>
              <button onclick="copyBuyerName()" class="flex-shrink-0 p-2 text-slate-400 border-2 border-gray-300 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-colors duration-200" title="Скопировать покупателя">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <div class="border-t border-slate-400 bg-slate-100">
          <div class="px-6 py-4">
            <div class="flex items-center justify-between cursor-pointer hover:bg-slate-200 transition-colors duration-200 rounded-lg p-2 -m-2" onclick="toggleTotalsSection()">
              <div class="flex items-center">
                <button onclick="event.stopPropagation(); toggleTotalsSection()" class="mr-3 p-1 bg-white border-2 border-slate-300 rounded-lg transition-colors duration-200 text-slate-600 hover:text-white hover:bg-slate-600" id="totals-toggle-btn">
                  <svg class="w-5 h-5 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="totals-toggle-icon" style="transform: rotate(-90deg)">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>

                <div class="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center mr-3 border-2 border-emerald-200">
                  <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                  </svg>
                </div>
                <h3 class="text-sm font-semibold text-slate-900">Итоговые значения</h3>
              </div>

              <div id="totals-status" class="flex items-center space-x-3 hidden" onclick="event.stopPropagation()">
                <div id="status-badge" class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium shadow-sm">
                  <div id="status-icon" class="w-4 h-4 mr-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                  </div>
                  <span id="status-text"></span>
                </div>
              </div>
            </div>

            <div id="totals-content" class="hidden mt-4">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-3">
                  <div class="flex items-center mb-3 px-2">
                    <div class="w-4 h-4 bg-emerald-500 rounded mr-2"></div>
                    <h4 class="text-sm font-semibold text-slate-800">
                      Итоговые данные по документу
                    </h4>
                  </div>
                  <div id="totals-summary" class="space-y-2"></div>
                </div>
                <div class="space-y-3">
                  <div class="flex items-center mb-3 px-2">
                    <div class="w-4 h-4 bg-purple-500 rounded mr-2"></div>
                    <h4 class="text-sm font-semibold text-slate-800">
                      Рассчитанные данные
                    </h4>
                  </div>
                  <div id="totals-calc" class="space-y-2"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="bg-gradient-to-r from-slate-800 to-slate-900 px-6 py-4 flex justify-between items-center">
          <h2 class="text-xl font-semibold text-white flex items-center">
            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <rect x="3" y="5" width="18" height="14" rx="2" ry="2" stroke-width="2"/>
              <line x1="3" y1="9" x2="21" y2="9" stroke-width="2"/>
              <line x1="9" y1="9" x2="9" y2="19" stroke-width="2"/>
              <line x1="15" y1="9" x2="15" y2="19" stroke-width="2"/>
            </svg>
            Таблица данных
          </h2>
          <div class="flex space-x-2">
          <button id="copy-btn" class="inline-flex items-center px-4 py-2 bg-white text-slate-800 text-sm border border-gray-300 font-medium rounded-lg hover:bg-blue-900 hover:text-white/100 transition-colors duration-200 shadow-sm">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            Скопировать
          </button>
            <button id="save-btn" class="inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors duration-200 shadow-sm">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
              </svg>
              Сохранить
          </button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table id="data-table" class="w-full">
            <thead id="table-head" class="bg-slate-50 border-b border-slate-200"></thead>
            <tbody id="table-body" class="divide-y divide-slate-200"></tbody>
          </table>
        </div>
        <div id="loading-state" class="flex items-center justify-center py-12">
          <div class="flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            <span class="text-slate-600">Загрузка данных...</span>
          </div>
        </div>
      </div>
    
    </main>
    <div id="toast" class="fixed top-4 right-4 transform translate-x-full transition-transform duration-300 ease-in-out z-50">
      <div class="bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span>Таблица скопирована в буфер обмена!</span>
      </div>
    </div>

    <script>
      function formatNumber(value) {
        const num = parseFloat(value);
        if (isNaN(num)) return value;
        return num.toLocaleString('ru-RU', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }

      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const toastContent = toast.querySelector("div");
        
        toastContent.className = type === "success" 
          ? "bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2"
          : "bg-red-600 text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2";
        
        toastContent.querySelector("span").textContent = message;
        toast.classList.remove("translate-x-full");
        setTimeout(() => toast.classList.add("translate-x-full"), 500);
      }

      async function fetchData() {
        try {
          const savedData = localStorage.getItem("mapato_data");
          if (!savedData) {
            showNoDataMessage();
            return;
          }

          const data = JSON.parse(savedData);
          const uploadTime = localStorage.getItem("mapato_upload_time");

          document.getElementById("loading-state").style.display = "none";
          updateSenderInfo(data.sender, data.truck, uploadTime, data.recipient, data.buyer);
          generateTable(data.containers);
          generateTotals(data.totals);
          generateCalc(data.calc);
        } catch (error) {
          console.error("Error loading data:", error);
          showToast("Ошибка загрузки данных", "error");
          showErrorMessage();
        }
      }

      function showNoDataMessage() {
        document.getElementById("loading-state").innerHTML = `
          <div class="flex flex-col items-center justify-center py-12 space-y-4">
            <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="text-center">
              <p class="text-lg font-semibold text-gray-600">Нет загруженных данных</p>
              <p class="text-gray-500 mt-2">Сначала загрузите файл для обработки</p>
              <a href="/" class="inline-flex items-center mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                Загрузить файл
              </a>
            </div>
          </div>
        `;
      }

      function showErrorMessage() {
        document.getElementById("loading-state").innerHTML = `
          <div class="flex flex-col items-center justify-center py-12 space-y-4">
            <svg class="w-16 h-16 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="text-center">
              <p class="text-lg font-semibold text-red-600">Ошибка загрузки данных</p>
              <p class="text-gray-500 mt-2">Возможно, данные повреждены</p>
              <button onclick="clearLocalData()" class="inline-flex items-center mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Очистить данные
              </button>
            </div>
          </div>
        `;
      }

      // Update sender information
      function updateSenderInfo(sender, truck, uploadTime, recipient, buyer) {
        document.getElementById("sender-name").textContent =
          sender || "Не указан";
        document.getElementById("truck-number").textContent =
          truck || "Не указан";

        // Обновляем получателя, если элемент существует
        const recipientElement = document.getElementById("recipient-name");
        if (recipientElement) {
          recipientElement.textContent = recipient || "Не указан";
        }

        // Обновляем время загрузки, если элемент существует
        if (uploadTime) {
          const time = new Date(uploadTime);
          const timeString = time.toLocaleString("ru-RU", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          });

          const timeElement = document.getElementById("upload-time");
          if (timeElement) {
            timeElement.textContent = timeString;
          }
        }

        // Обновляем покупателя, если элемент существует
        const buyerSection = document.getElementById("additional-info-1");
        if (buyer && buyer.trim() !== "") {
          buyerSection.style.display = "block";
        } else {
          buyerSection.style.display = "none";
        }
        
        const buyerElement = document.getElementById("buyer-name");
        if (buyerElement) {
          buyerElement.textContent = buyer || "Не указан";
        }
      }

      // Generate table headers and rows
      function generateTable(data) {
        const thead = document.getElementById("table-head");
        const tbody = document.getElementById("table-body");

        // Проверяем, есть ли данные в контейнерах
        if (!data || Object.keys(data).length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="100%" class="text-center py-8 text-slate-500">Нет данных для отображения</td></tr>';
            return;
          }
        
        // Генерируем группированные таблицы
          generateGroupedTables(data);
      }


      // Генерация таблиц по группам контейнеров
      function generateGroupedTables(containerData) {
        const tableContainer = document.querySelector(
          ".bg-white.rounded-xl.shadow-sm.border.border-slate-200.overflow-hidden:nth-child(2)"
        );

        if (Object.keys(containerData).length === 0) {
          document.getElementById("table-body").innerHTML =
            '<tr><td colspan="100%" class="text-center py-8 text-slate-500">Нет данных для отображения</td></tr>';
          return;
        }

        // Очищаем существующую таблицу
        const tableWrapper = tableContainer.querySelector(".overflow-x-auto");
        tableWrapper.innerHTML = "";

        // Скрываем общую кнопку копирования, так как теперь всегда используются группированные данные
        const generalCopyBtn = document.getElementById("copy-btn");
        if (generalCopyBtn) {
          generalCopyBtn.style.display = "none";
        }

        let globalRowIndex = 0;

        // Создаем отдельную таблицу для каждого контейнера
        Object.entries(containerData).forEach(([containerNo, rows]) => {
          if (rows.length === 0) return;

          const headers = Object.keys(rows[0]);

          const tableHtml = `
            <div class="mb-0 border-t border-slate-400 pb-0">
              <div class="flex justify-between items-center px-6 py-2 bg-slate-200 rounded mb-0 cursor-pointer hover:bg-slate-300 transition-colors duration-200" onclick="toggleContainer('${containerNo}')">
                <div class="flex items-center">
                  <button
                    onclick="event.stopPropagation(); toggleContainer('${containerNo}')"
                    class="mr-3 p-1 bg-white border-2 border-slate-300 rounded-lg transition-colors duration-200 text-slate-600 hover:text-white hover:bg-slate-600"
                    id="toggle-btn-${containerNo}"
                  >
                    <svg class="w-5 h-5 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="toggle-icon-${containerNo}" style="transform: rotate(-90deg);">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </button>
                  <h3 class="text-lg font-semibold text-slate-800">
                    Контейнер ${
                      Object.keys(containerData).indexOf(containerNo) + 1
                    }: ${containerNo}
                    <span class="text-sm font-normal text-slate-600 ml-2">(${
                      rows.length
                    } позиций)</span>
                  </h3>
                </div>
                <div class="flex space-x-2" onclick="event.stopPropagation()">
                  <button
                    onclick="copyContainerNoToClipboard('${containerNo}')"
                    class="inline-flex items-center px-3 py-1 bg-white text-slate-800 text-sm border border-gray-300 font-medium rounded-lg hover:bg-blue-600 hover:text-white transition-colors duration-200 shadow-sm"
                  >
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    Скопировать номер контейнера
                  </button>
                  <button
                    onclick="copyContainerToClipboard('${containerNo}')"
                    class="inline-flex items-center px-3 py-1 bg-white text-slate-800 text-sm border border-gray-300 font-medium rounded-lg hover:bg-blue-600 hover:text-white transition-colors duration-200 shadow-sm"
                  >
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    Скопировать таблицу
                  </button>
                </div>
              </div>
              <div class="overflow-x-auto transition-all duration-300" id="container-content-${containerNo}" style="display: none;">
                <table class="w-full container-table table-fixed" data-container="${containerNo}">
                  <thead class="bg-slate-50 border-b border-slate-200">
                    <tr>
                      ${headers
                        .filter((header) => header !== "Case No")
                        .map(
                          (header) => `
                          <th class="px-2 py-2 text-left text-xs font-semibold text-slate-700 tracking-normal ${
                            header === "Коммерческое описание товара"
                              ? "w-1/4 min-w-0"
                              : "w-auto"
                          }">
                              ${
                                header === "Вид упаковки "
                                  ? `
                                  <div class="flex flex-col space-y-2">
                                      <span>${header}</span>
                                      <select 
                                          class="bulk-package-select" 
                                          data-container="${containerNo}"
                                          onchange="changeBulkPackageTypeForContainer('${containerNo}', this.value)"
                                          class="text-xs bg-white border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      >
                                          <option value="">Выбрать для всех</option>
                                          <option value="CT">CT</option>
                                          <option value="PK">PK</option>
                                          <option value="CS">CS</option>
                                          <option value="PP">PP</option>
                                      </select>
                                  </div>
                              `
                                  : header === "Информация об упаковке (0-БЕЗ, 1 С)"
                                  ? `
                                  <div class="flex flex-col space-y-2">
                                      <span>${header}</span>
                                      <select 
                                          class="bulk-package-info-select" 
                                          data-container="${containerNo}"
                                          onchange="changeBulkPackageInfoForContainer('${containerNo}', this.value)"
                                          class="text-xs bg-white border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      >
                                          <option value="">Выбрать для всех</option>
                                          <option value="0">0 - БЕЗ</option>
                                          <option value="1">1 - С</option>
                                      </select>
                                  </div>
                              `
                                  : header
                              }
                          </th>
                      `
                        )
                        .join("")}
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-200">
                    ${rows
                      .map(
                        (row, index) => `
                        <tr class="hover:bg-slate-50 transition-colors duration-150 ${
                          index % 2 === 0 ? "bg-white" : "bg-slate-25"
                        }">
                            ${Object.entries(row)
                              .filter(([key, value]) => key !== "Case No")
                              .map(
                                ([key, value]) => `
                                <td class="px-2 py-1 text-sm text-slate-900 ${
                                  key === "Коммерческое описание товара"
                                    ? "min-w-0 relative"
                                    : "whitespace-nowrap"
                                }">
                                    ${
                                      key === "Коммерческое описание товара"
                                        ? `
                                        <div 
                                            class="cursor-pointer overflow-hidden text-ellipsis"
                                            style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; line-height: 1.2em; max-height: 3.6em;"
                                            onclick="toggleTextExpansion(this)"
                                            title="Нажмите для развертывания/свертывания"
                                        >
                                            ${value}
                                        </div>
                                        `
                                        : key === "Вид упаковки "
                                        ? `
                                        <select 
                                            class="package-type-select text-sm bg-white border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full"
                                            onchange="updatePackageType('${containerNo}', ${index}, this.value)"
                                            data-row-index="${globalRowIndex}"
                                            data-container="${containerNo}"
                                        >
                                            <option value="CT" ${
                                              value === "CT" ? "selected" : ""
                                            }>CT</option>
                                            <option value="PK" ${
                                              value === "PK" ? "selected" : ""
                                            }>PK</option>
                                            <option value="CS" ${
                                              value === "CS" ? "selected" : ""
                                            }>CS</option>
                                            <option value="PP" ${
                                              value === "PP" ? "selected" : ""
                                            }>PP</option>
                                        </select>
                                    `
                                        : key === "Информация об упаковке (0-БЕЗ, 1 С)"
                                        ? `
                                        <select 
                                            class="package-info-select text-sm bg-white border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full"
                                            onchange="updatePackageInfo('${containerNo}', ${index}, this.value)"
                                            data-row-index="${globalRowIndex}"
                                            data-container="${containerNo}"
                                        >
                                            <option value="0" ${
                                              value == 0 ? "selected" : ""
                                            }>0 - БЕЗ</option>
                                            <option value="1" ${
                                              value == 1 ? "selected" : ""
                                            }>1 - С</option>
                                        </select>
                                    `
                                        : value
                                    }
                                </td>
                            `
                              )
                              .join("")}
                        </tr>
                    `
                      )
                      .join("")}
                  </tbody>
                </table>
              </div>
            </div>
          `;

          globalRowIndex += rows.length;
          tableWrapper.insertAdjacentHTML("beforeend", tableHtml);
        });

        // Добавляем функцию для сворачивания/разворачивания контейнеров
        window.toggleContainer = function (containerNo) {
          const content = document.getElementById(
            `container-content-${containerNo}`
          );
          const icon = document.getElementById(`toggle-icon-${containerNo}`);

          if (content.style.display === "none") {
            content.style.display = "block";
            icon.style.transform = "rotate(0deg)";
          } else {
            content.style.display = "none";
            icon.style.transform = "rotate(-90deg)";
          }
        };
      }

      // Generate totals summary
      function generateTotals(totals) {
        const totalsNames = {
          total_quantity: "Кол-во мест",
          total_weight: "Вес брутто",
          total_amount: "Сумма",
        };

        const totalsContainer = document.getElementById("totals-summary");
        totalsContainer.innerHTML = `
                ${Object.entries(totals)
                  .map(
                    ([key, value]) => `
                    <div id="total-${key}" class="flex justify-between items-center py-2 px-3 bg-slate-50 rounded-lg">
                        <span class="text-sm font-medium text-slate-600">${
                          totalsNames[key] || key
                        }</span>
                        <span class="text-sm font-bold text-slate-900">${formatNumber(value)}</span>
                    </div>
                `
                  )
                  .join("")}
            `;
      }

      // Generate summary for calc
      function generateCalc(calc) {
        const calcNames = {
          calc_quantity: "Кол-во мест",
          calc_weight: "Вес брутто",
          calc_amount: "Сумма",
        };

        const calcContainer = document.getElementById("totals-calc");
        calcContainer.innerHTML = `
                ${Object.entries(calc)
                  .map(
                    ([key, value]) => `
                    <div id="calc-${key}" class="flex justify-between items-center py-2 px-3 bg-slate-50 rounded-lg">
                        <span class="text-sm font-medium text-slate-600">${
                          calcNames[key] || key
                        }</span>
                        <span class="text-sm font-bold text-slate-900">${formatNumber(value)}</span>
                    </div>
                `
                  )
                  .join("")}
            `;

        compareValues(calc);
      }

      function compareValues(calc) {
        const savedData = localStorage.getItem("mapato_data");
        if (!savedData) return;

        const data = JSON.parse(savedData);
        const totals = data.totals;

        let hasDiscrepancies = false;

        // Функция для сравнения чисел с плавающей точкой с допустимой погрешностью
        function isEqualWithTolerance(a, b, tolerance = 0.01) {
          return Math.abs(a - b) < tolerance;
        }

        // Compare values and highlight discrepancies
        const comparisons = [
          {
            totalKey: "total_quantity",
            calcKey: "calc_quantity",
            name: "Кол-во мест",
          },
          {
            totalKey: "total_weight",
            calcKey: "calc_weight",
            name: "Вес брутто",
          },
          { totalKey: "total_amount", 
            calcKey: "calc_amount", 
            name: "Сумма" 
          },
        ];

        comparisons.forEach((comp) => {
          const totalValue = parseFloat(totals[comp.totalKey]) || 0;
          const calcValue = parseFloat(calc[comp.calcKey]) || 0;
          
          // Используем сравнение с допустимой погрешностью
          const isMatch = isEqualWithTolerance(totalValue, calcValue);
          
          // Отладочная информация
          console.log(`Сравнение ${comp.name}:`, {
            totalValue: totalValue,
            calcValue: calcValue,
            difference: Math.abs(totalValue - calcValue),
            isMatch: isMatch
          });

          // Получаем элементы для обновления стилей
          const totalElement = document.getElementById(`total-${comp.totalKey}`);
          const calcElement = document.getElementById(`calc-${comp.calcKey}`);

          if (!isMatch) {
            hasDiscrepancies = true;
            // Highlight discrepant values
            if (totalElement) {
              totalElement.classList.remove("bg-slate-50", "bg-green-100", "border-green-500");
              totalElement.classList.add("bg-red-100", "border", "border-red-300");
            }
            if (calcElement) {
              calcElement.classList.remove("bg-slate-50", "bg-green-100", "border-green-500");
              calcElement.classList.add("bg-red-100", "border", "border-red-300");
            }
          } else {
            // Highlight matching values
            if (totalElement) {
              totalElement.classList.remove("bg-slate-50", "bg-red-100", "border-red-300");
              totalElement.classList.add("bg-green-100", "border", "border-green-500");
            }
            if (calcElement) {
              calcElement.classList.remove("bg-slate-50", "bg-red-100", "border-red-300");
              calcElement.classList.add("bg-green-100", "border", "border-green-500");
            }
          }
        });

        // Update status indicator
        updateTotalsStatus(hasDiscrepancies);
      }

      // Update totals status indicator
      function updateTotalsStatus(hasDiscrepancies) {
        const statusElement = document.getElementById("totals-status");
        const statusBadge = document.getElementById("status-badge");
        const statusIcon = document.getElementById("status-icon");
        const statusText = document.getElementById("status-text");

        // Всегда показываем статус
        statusElement.classList.remove("hidden");

        if (hasDiscrepancies) {
          // Есть расхождения - показываем предупреждение
          statusBadge.className =
            "inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium shadow-sm bg-red-100 border-2 border-red-300 text-red-800";
          statusIcon.innerHTML = `
            <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
          `;
          statusText.textContent = "Несхождение данных";
        } else {
          // Все данные совпадают - показываем успех
          statusBadge.className =
            "inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium shadow-sm bg-green-100 border-2 border-green-300 text-green-800";
          statusIcon.innerHTML = `
            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          `;
          statusText.textContent = "Схождение данных";
        }
      }

      // Toggle totals section
      function toggleTotalsSection() {
        const content = document.getElementById("totals-content");
        const icon = document.getElementById("totals-toggle-icon");

        if (content.classList.contains("hidden")) {
          content.classList.remove("hidden");
          icon.style.transform = "rotate(0deg)";
        } else {
          content.classList.add("hidden");
          icon.style.transform = "rotate(-90deg)";
        }
      }

      // Copy table to clipboard
      function copyTableToClipboard() {
        let text = "";

        // Проверяем, есть ли группированные таблицы
        const containerTables = document.querySelectorAll(".container-table");

        // Копируем таблицу
        const table = document.getElementById("data-table");
        if (table) {
          // Старый формат - одна таблица
          const table = document.getElementById("data-table");
          if (table) {
            table.querySelectorAll("tbody tr").forEach((row) => {
              const cells = [...row.querySelectorAll("td")].map((td) => {
                const packageSelect = td.querySelector("select.package-type-select");
                if (packageSelect) {
                  return packageSelect.value;
                }
                const packageInfoSelect = td.querySelector("select.package-info-select");
                if (packageInfoSelect) {
                  return packageInfoSelect.value;
                }
                return td.textContent.trim();
              });
              text += cells.join("\t") + "\n";
            });
          }
        }

        text = text.replace(/\./g, ","); // Заменить все точки на запятые

        navigator.clipboard
          .writeText(text)
          .then(() => {
            showToast("Таблица скопирована в буфер обмена!");
          })
          .catch((err) => {
            console.error("Ошибка копирования:", err);
            showToast("Ошибка копирования данных", "error");
          });
      }

      // Copy specific container table to clipboard
      function copyContainerToClipboard(containerNo) {
        const containerTable = document.querySelector(
          `[data-container="${containerNo}"]`
        );

        if (!containerTable) {
          showToast("Контейнер не найден", "error");
          return;
        }

        //let text = `Контейнер: ${containerNo}\n`;
        let text = "";

        // Get rows for this container
        containerTable.querySelectorAll("tbody tr").forEach((row) => {
          const cells = [...row.querySelectorAll("td")].map((td) => {
            // Проверяем, есть ли в ячейке селект для вида упаковки
            const packageSelect = td.querySelector("select.package-type-select");
            if (packageSelect) {
              // Если есть селект вида упаковки, берем его выбранное значение
              return packageSelect.value;
            }
            // Проверяем, есть ли в ячейке селект для информации об упаковке
            const packageInfoSelect = td.querySelector("select.package-info-select");
            if (packageInfoSelect) {
              // Если есть селект информации об упаковке, берем его выбранное значение
              return packageInfoSelect.value;
            }
            // Иначе берем обычный текст
            return td.textContent.trim();
          });
          text += cells.join("\t") + "\n";
        });

        text = text.replace(/\./g, ","); // Заменить все точки на запятые

        navigator.clipboard
          .writeText(text)
          .then(() => {
            showToast(`Контейнер ${containerNo} скопирован в буфер обмена!`);
          })
          .catch((err) => {
            console.error("Ошибка копирования:", err);
            showToast("Ошибка копирования данных", "error");
          });
      }

      function copyToClipboard(text, successMessage) {
        if (!text || text === "Загрузка..." || text === "Не указан") {
          showToast("Нет данных для копирования", "error");
          return;
        }
        navigator.clipboard.writeText(text)
          .then(() => showToast(successMessage))
          .catch(() => showToast("Ошибка копирования", "error"));
      }

      function copySenderName() {
        const text = document.getElementById("sender-name").textContent;
        copyToClipboard(text, "Отправитель скопирован в буфер обмена!");
      }

      function copyContainerNumber() {
        const text = document.getElementById("truck-number").textContent;
        copyToClipboard(text, "Номер контейнера скопирован в буфер обмена!");
      }

      function copyContainerNoToClipboard(containerNo) {
        copyToClipboard(containerNo, `Номер контейнера ${containerNo} скопирован в буфер обмена!`);
      }

      function copyRecipientName() {
        const text = document.getElementById("recipient-name").textContent;
        copyToClipboard(text, "Получатель скопирован в буфер обмена!");
      }

      function copyBuyerName() {
        const text = document.getElementById("buyer-name").textContent;
        copyToClipboard(text, "Покупатель скопирован в буфер обмена!");
      }

      function clearLocalData() {
        localStorage.removeItem("mapato_data");
        localStorage.removeItem("mapato_upload_time");
        window.location.href = "/";
      }

      function goBackToUpload() {
        clearLocalData();
      }



      function updatePackageType(containerNo, rowIndex, value) {
        console.log("updatePackageType вызвана с параметрами:", {containerNo, rowIndex, value, type: typeof rowIndex});
        
        // Преобразуем rowIndex в число, если это строка
        const numericRowIndex = parseInt(rowIndex, 10);
        console.log("Преобразованный rowIndex:", numericRowIndex);
        
        // Обновляем данные в localStorage
        const savedData = localStorage.getItem("mapato_data");
        if (savedData) {
          const data = JSON.parse(savedData);
          console.log("Данные из localStorage:", data);
          console.log("Контейнеры:", data.containers);
          console.log("Конкретный контейнер:", data.containers?.[containerNo]);
          console.log("Строка для обновления:", data.containers?.[containerNo]?.[numericRowIndex]);
          
          if (data.containers && data.containers[containerNo] && data.containers[containerNo][numericRowIndex]) {
            data.containers[containerNo][numericRowIndex]["Вид упаковки "] = value;
            localStorage.setItem("mapato_data", JSON.stringify(data));
            
            // Обновляем итоговые значения после изменения
            updateTotalsAfterPackageChange(data);
            
            showToast(`Вид упаковки изменен на ${value} для товара в контейнере ${containerNo}`);
            console.log("Обновление успешно выполнено");
          } else {
            console.error("Не удалось найти данные для обновления:", {containerNo, rowIndex: numericRowIndex, value});
            console.error("Проверка условий:", {
              hasContainers: !!data.containers,
              hasContainer: !!data.containers?.[containerNo],
              hasRow: !!data.containers?.[containerNo]?.[numericRowIndex],
              containerKeys: data.containers ? Object.keys(data.containers) : "нет контейнеров",
              containerRows: data.containers?.[containerNo] ? data.containers[containerNo].length : "нет строк",
              originalRowIndex: rowIndex,
              numericRowIndex: numericRowIndex
            });
            showToast("Ошибка при обновлении вида упаковки", "error");
          }
        } else {
          console.error("Нет данных в localStorage");
          showToast("Нет данных для обновления", "error");
        }
      }

      function updateTotalsAfterPackageChange(data) {
        // Пересчитываем итоговые значения
        let totalQuantity = 0;
        let totalWeight = 0;
        let totalAmount = 0;
        
        Object.values(data.containers).forEach(containerRows => {
          containerRows.forEach(row => {
            const quantity = parseFloat(row["Количество грузовых мест"]) || 0;
            const weight = parseFloat(row["Вес брутто"]) || 0;
            const amount = parseFloat(row["Сумма"]) || 0;
            
            totalQuantity += quantity;
            totalWeight += weight;
            totalAmount += amount;
          });
        });
        
        // Обновляем данные в localStorage
        data.totals = {
          total_quantity: totalQuantity,
          total_weight: totalWeight,
          total_amount: totalAmount
        };
        
        localStorage.setItem("mapato_data", JSON.stringify(data));
        
        // Обновляем отображение итогов
        generateTotals(data.totals);
        generateCalc(data.calc);
        
        // Принудительно вызываем сравнение для обновления статуса
        compareValues(data.calc);
      }

      function changeBulkPackageType(value) {
        if (!value) return;
        
        // Обновляем данные в localStorage
        const savedData = localStorage.getItem("mapato_data");
        if (savedData) {
          const data = JSON.parse(savedData);
          if (data.containers) {
            // Обновляем все товары во всех контейнерах
            Object.keys(data.containers).forEach(containerNo => {
              data.containers[containerNo].forEach(row => {
                row["Вид упаковки "] = value;
              });
            });
            localStorage.setItem("mapato_data", JSON.stringify(data));
            
            // Обновляем итоговые значения
            updateTotalsAfterPackageChange(data);
          }
        }
        
        // Обновляем UI
        const packageSelects = document.querySelectorAll(".package-type-select");
        packageSelects.forEach((select) => {
          select.value = value;
        });
        
        document.getElementById("bulk-package-select").value = "";
        showToast(`Вид упаковки изменен на ${value} для всех товаров`);
      }

      function changeBulkPackageTypeForContainer(containerNo, value) {
        if (!value) return;
        
        // Обновляем данные в localStorage
        const savedData = localStorage.getItem("mapato_data");
        if (savedData) {
          const data = JSON.parse(savedData);
          if (data.containers && data.containers[containerNo]) {
            // Обновляем все товары в этом контейнере
            data.containers[containerNo].forEach(row => {
              row["Вид упаковки "] = value;
            });
            localStorage.setItem("mapato_data", JSON.stringify(data));
            
            // Обновляем итоговые значения
            updateTotalsAfterPackageChange(data);
          }
        }
        
        // Обновляем UI
        const containerTable = document.querySelector(`[data-container="${containerNo}"]`);
        const packageSelects = containerTable.querySelectorAll(".package-type-select");
        packageSelects.forEach((select) => {
          select.value = value;
        });
        
        const bulkSelect = containerTable.querySelector(".bulk-package-select");
        if (bulkSelect) bulkSelect.value = "";
        showToast(`Вид упаковки изменен на ${value} для контейнера ${containerNo}`);
      }

      function updatePackageInfo(containerNo, rowIndex, value) {
        console.log("updatePackageInfo вызвана с параметрами:", {containerNo, rowIndex, value, type: typeof rowIndex});
        
        // Преобразуем rowIndex в число, если это строка
        const numericRowIndex = parseInt(rowIndex, 10);
        console.log("Преобразованный rowIndex:", numericRowIndex);
        
        // Преобразуем value в число
        const numericValue = parseInt(value, 10);
        
        // Обновляем данные в localStorage
        const savedData = localStorage.getItem("mapato_data");
        if (savedData) {
          const data = JSON.parse(savedData);
          console.log("Данные из localStorage:", data);
          console.log("Контейнеры:", data.containers);
          console.log("Конкретный контейнер:", data.containers?.[containerNo]);
          console.log("Строка для обновления:", data.containers?.[containerNo]?.[numericRowIndex]);
          
          if (data.containers && data.containers[containerNo] && data.containers[containerNo][numericRowIndex]) {
            // Проверяем текущее значение перед изменением
            const currentValue = data.containers[containerNo][numericRowIndex]["Информация об упаковке (0-БЕЗ, 1 С)"];
            console.log("Текущее значение:", currentValue, "Новое значение:", numericValue);
            
            data.containers[containerNo][numericRowIndex]["Информация об упаковке (0-БЕЗ, 1 С)"] = numericValue;
            localStorage.setItem("mapato_data", JSON.stringify(data));
            
            // Проверяем, что значение действительно сохранилось
            const savedData = JSON.parse(localStorage.getItem("mapato_data"));
            const savedValue = savedData.containers[containerNo][numericRowIndex]["Информация об упаковке (0-БЕЗ, 1 С)"];
            console.log("Сохраненное значение:", savedValue);
            
            showToast(`Информация об упаковке изменена на ${value} для товара в контейнере ${containerNo}`);
            console.log("Обновление успешно выполнено");
          } else {
            console.error("Не удалось найти данные для обновления:", {containerNo, rowIndex: numericRowIndex, value});
            showToast("Ошибка при обновлении информации об упаковке", "error");
          }
        } else {
          console.error("Нет данных в localStorage");
          showToast("Нет данных для обновления", "error");
        }
      }

      function changeBulkPackageInfoForContainer(containerNo, value) {
        if (!value) return;
        
        // Преобразуем value в число
        const numericValue = parseInt(value, 10);
        
        // Обновляем данные в localStorage
        const savedData = localStorage.getItem("mapato_data");
        if (savedData) {
          const data = JSON.parse(savedData);
          if (data.containers && data.containers[containerNo]) {
            // Обновляем все товары в этом контейнере
            data.containers[containerNo].forEach(row => {
              row["Информация об упаковке (0-БЕЗ, 1 С)"] = numericValue;
            });
            localStorage.setItem("mapato_data", JSON.stringify(data));
          }
        }
        
        // Обновляем UI
        const containerTable = document.querySelector(`[data-container="${containerNo}"]`);
        const packageInfoSelects = containerTable.querySelectorAll(".package-info-select");
        packageInfoSelects.forEach((select) => {
          select.value = value;
        });
        
        const bulkSelect = containerTable.querySelector(".bulk-package-info-select");
        if (bulkSelect) bulkSelect.value = "";
        showToast(`Информация об упаковке изменена на ${value} для контейнера ${containerNo}`);
      }

      // Save data to server
      async function saveDataToServer() {
        try {
          const savedData = localStorage.getItem("mapato_data");
          if (!savedData) {
            showToast("Нет данных для сохранения", "error");
            return;
          }

          // Отладочная информация - проверяем данные перед отправкой
          const data = JSON.parse(savedData);
          console.log("Данные перед отправкой на сервер:", data);
          
          // Проверяем значения "Информация об упаковке" во всех контейнерах
          Object.keys(data.containers || {}).forEach(containerNo => {
            console.log(`Контейнер ${containerNo}:`);
            data.containers[containerNo].forEach((row, index) => {
              const packageInfo = row["Информация об упаковке (0-БЕЗ, 1 С)"];
              console.log(`  Строка ${index}: package_info = ${packageInfo}`);
            });
          });

          // Отправляем данные из localStorage на сервер
          // Изменения уже должны быть сохранены в localStorage через updatePackageInfo и updatePackageType
          const response = await fetch('/save', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: savedData
          });

          if (response.ok) {
            const result = await response.json();
            showToast(result.message || "Данные успешно сохранены!", "success");
          } else {
            const error = await response.json();
            showToast(error.detail || "Ошибка при сохранении данных", "error");
          }
        } catch (error) {
          console.error("Ошибка при сохранении:", error);
          showToast("Ошибка при сохранении данных", "error");
        }
      }


      document.getElementById("copy-btn").addEventListener("click", copyTableToClipboard);
      document.getElementById("save-btn").addEventListener("click", saveDataToServer);
      fetchData();
    </script>
  </body>
</html>
<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Сравнение ТД с Инвойсом</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>
    <style>
      .autocomplete-wrap { position: relative; }
      .suggestion-layer { position: absolute; inset: 0; pointer-events: none; display: flex; align-items: center; padding-left: 0.75rem; padding-right: 2.5rem; color: rgba(107, 114, 128, 0.5); font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .suggestion-prefix { color: transparent; }
      .input-ghost { background: transparent; position: relative; z-index: 2; }
      .sr-only { position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
      .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
      .card-shadow { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
      .upload-zone-hover:hover { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-color: #3b82f6; }
      .pulse-animation { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 font-sans">
    <div class="min-h-screen flex items-center justify-center p-4 sm:p-6 lg:p-8">
      <main class="w-full max-w-2xl">
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl card-shadow overflow-hidden">
          <div class="gradient-bg px-6 sm:px-8 py-6">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
              </div>
              <div>
                <h1 class="text-xl font-bold text-white">Сравнение ТД с Инвойсом</h1>
                <p class="text-white/80 text-sm">Выберите отправителя и загрузите файлы</p>
              </div>
            </div>
          </div>

          <div class="p-6 sm:p-8">
            <div class="mb-6 flex items-center justify-center">
              <div class="inline-flex bg-gray-100 rounded-xl p-1">
                <button id="mode1Btn" type="button" class="px-4 py-2 rounded-lg text-gray-600">Импорт из Инвойса</button>
                <button id="mode2Btn" type="button" class="px-4 py-2 rounded-lg bg-white shadow text-gray-900 font-semibold">Сравнение ТД с Инвойсом</button>
              </div>
            </div>

            <form id="compareForm" action="/compare" method="post" enctype="multipart/form-data" class="space-y-6" novalidate>
              <div class="space-y-2">
                <label for="senderSearch" class="block text-sm font-semibold text-gray-900">
                  Отправитель
                  <span class="text-red-500 ml-1">*</span>
                </label>

                <div class="relative autocomplete-wrap">
                  <div id="suggestion" class="suggestion-layer rounded-xl border border-transparent px-4 py-3 text-sm"></div>
                  <input id="senderSearch" name="senderSearch" type="text" class="input-ghost w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 transition-all duration-200" placeholder="Начните вводить имя отправителя..." autocomplete="off" aria-autocomplete="both"/>

                  <button id="clearBtn" type="button" class="absolute right-3 top-3 w-6 h-6 text-gray-400 hover:text-gray-600 hidden rounded-full hover:bg-gray-100 flex items-center justify-center transition-colors z-10" title="Очистить поле">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>

                  <div id="senderDropdown" class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-lg z-10 max-h-60 overflow-y-auto hidden"></div>
                </div>

                <input type="hidden" id="sender" name="sender" required />

                <div class="flex items-center gap-2 text-xs text-gray-500">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <span>Нажмите <kbd class="px-2 py-1 bg-gray-100 rounded-md border text-xs font-mono">Tab</kbd> для принятия подсказки</span>
                </div>
              </div>

              <div class="space-y-2">
                <label class="block text-sm font-semibold text-gray-900">
                  Инвойс (Excel)
                  <span class="text-red-500 ml-1">*</span>
                </label>
                <div id="invoiceWrapper" class="relative">
                  <label id="invoiceZone" for="invoiceFile" class="upload-zone-hover flex flex-col items-center justify-center gap-4 border-2 border-dashed border-gray-300 rounded-2xl p-8 cursor-pointer bg-gray-50/50 transition-all duration-300 hover:shadow-lg group" tabindex="0">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                      <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10,9 9,9 8,9"/>
                      </svg>
                    </div>
                    <div class="text-center">
                      <div class="text-base font-semibold text-gray-700 mb-1">Перетащите файл сюда или нажмите для выбора</div>
                      <div class="text-sm text-gray-500">Поддерживаются форматы .xlsx и .xls</div>
                    </div>
                  </label>

                  <div id="invoiceView" class="hidden relative border-2 border-green-200 rounded-2xl p-6 bg-gradient-to-r from-green-50 to-emerald-50">
                    <div class="flex items-center justify-between gap-4">
                      <div class="flex items-center gap-4 min-w-0">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center flex-shrink-0">
                          <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                            <polyline points="14,2 14,8 20,8"/>
                          </svg>
                        </div>
                        <div class="min-w-0">
                          <div id="invoiceFileName" class="text-base font-semibold text-gray-900 truncate"></div>
                          <div id="invoiceFileSize" class="text-sm text-gray-600 mt-1"></div>
                        </div>
                      </div>
                      <button id="removeInvoiceBtn" type="button" class="w-10 h-10 rounded-xl bg-red-100 text-red-600 hover:bg-red-200 flex items-center justify-center transition-colors duration-200" aria-label="Удалить файл">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
                <input id="invoiceFile" name="invoice" type="file" accept=".xlsx,.xls" class="sr-only" required />
              </div>

              <div class="space-y-2">
                <label class="block text-sm font-semibold text-gray-900">
                  Таможенная декларация (XML)
                  <span class="text-red-500 ml-1">*</span>
                </label>
                <div id="declWrapper" class="relative">
                  <label id="declZone" for="declFile" class="upload-zone-hover flex flex-col items-center justify-center gap-4 border-2 border-dashed border-gray-300 rounded-2xl p-8 cursor-pointer bg-gray-50/50 transition-all duration-300 hover:shadow-lg group" tabindex="0">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                      <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10,9 9,9 8,9"/>
                      </svg>
                    </div>
                    <div class="text-center">
                      <div class="text-base font-semibold text-gray-700 mb-1">Перетащите XML сюда или нажмите для выбора</div>
                      <div class="text-sm text-gray-500">Поддерживается формат .xml</div>
                    </div>
                  </label>

                  <div id="declView" class="hidden relative border-2 border-green-200 rounded-2xl p-6 bg-gradient-to-r from-green-50 to-emerald-50">
                    <div class="flex items-center justify-between gap-4">
                      <div class="flex items-center gap-4 min-w-0">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center flex-shrink-0">
                          <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                            <polyline points="14,2 14,8 20,8"/>
                          </svg>
                        </div>
                        <div class="min-w-0">
                          <div id="declFileName" class="text-base font-semibold text-gray-900 truncate"></div>
                          <div id="declFileSize" class="text-sm text-gray-600 mt-1"></div>
                        </div>
                      </div>
                      <button id="removeDeclBtn" type="button" class="w-10 h-10 rounded-xl bg-red-100 text-red-600 hover:bg-red-200 flex items-center justify-center transition-colors duration-200" aria-label="Удалить файл">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
                <input id="declFile" name="declaration" type="file" accept=".xml" class="sr-only" required />
              </div>

              <div class="pt-0">
                <button id="compareSubmit" type="submit" class="w-full inline-flex items-center justify-center gap-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold px-6 py-4 rounded-xl disabled:opacity-60 disabled:cursor-not-allowed transition-all duration-200 shadow-lg hover:shadow-xl">
                  <svg id="compareSpinner" class="w-5 h-5 hidden pulse-animation" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle cx="12" cy="12" r="10" stroke-width="3" stroke="currentColor"/>
                  </svg>
                  Показать имена файлов
                </button>
              </div>
            </form>

            <div id="compareResult" class="hidden mt-4 text-sm text-gray-800 bg-blue-50 border border-blue-200 rounded-xl p-4"></div>
          </div>
        </div>

        <div id="notification" class="fixed right-6 top-6 hidden z-50">
          <div id="notificationInner" class="px-6 py-4 rounded-xl shadow-2xl text-white font-semibold backdrop-blur-sm"></div>
        </div>
        <div id="loading" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center hidden z-50">
          <div class="bg-white rounded-2xl p-8 shadow-2xl flex items-center gap-4">
            <div class="w-8 h-8 border-4 border-gray-200 rounded-full border-t-blue-500 animate-spin"></div>
            <div class="text-gray-700 font-semibold">Загрузка файла...</div>
          </div>
        </div>
      </main>
    </div>

    <script type="application/json" id="processors-data">
      {{ compare_senders|tojson|safe }}
    </script>

    <script>
      const mode1Btn = document.getElementById("mode1Btn");
      const mode2Btn = document.getElementById("mode2Btn");
      mode1Btn.addEventListener("click", () => (location.href = "/"));
      mode2Btn.addEventListener("click", () => (location.href = "/compare"));

      function clearAllCache() {
        localStorage.removeItem("mapato_data");
        localStorage.removeItem("mapato_upload_time");
      }
      clearAllCache();

      const processorsData = document.getElementById("processors-data").textContent;
      const processorsList = JSON.parse(processorsData || "[]");

      const senderSearch = document.getElementById("senderSearch");
      const senderHidden = document.getElementById("sender");
      const suggestionEl = document.getElementById("suggestion");
      const clearBtn = document.getElementById("clearBtn");
      const senderDropdown = document.getElementById("senderDropdown");

      const invoiceFileInput = document.getElementById("invoiceFile");
      const invoiceZone = document.getElementById("invoiceZone");
      const invoiceView = document.getElementById("invoiceView");
      const invoiceFileName = document.getElementById("invoiceFileName");
      const invoiceFileSize = document.getElementById("invoiceFileSize");
      const removeInvoiceBtn = document.getElementById("removeInvoiceBtn");

      const declFileInput = document.getElementById("declFile");
      const declZone = document.getElementById("declZone");
      const declView = document.getElementById("declView");
      const declFileName = document.getElementById("declFileName");
      const declFileSize = document.getElementById("declFileSize");
      const removeDeclBtn = document.getElementById("removeDeclBtn");

      const compareForm = document.getElementById("compareForm");
      const compareSubmit = document.getElementById("compareSubmit");
      const compareSpinner = document.getElementById("compareSpinner");
      const compareResult = document.getElementById("compareResult");

      const notification = document.getElementById("notification");
      const notificationInner = document.getElementById("notificationInner");
      const loading = document.getElementById("loading");

      function showNotification(msg, type = "success") {
        notification.classList.remove("hidden");
        notificationInner.textContent = msg;
        notificationInner.className = "px-6 py-4 rounded-xl shadow-2xl text-white font-semibold backdrop-blur-sm " + (type === "error" ? "bg-red-600" : "bg-green-600");
        setTimeout(() => notification.classList.add("hidden"), 3000);
      }

      function setLoading(on) {
        loading.classList.toggle("hidden", !on);
      }

      function normalize(s) { return (s || "").toString().toLowerCase().replace(/\s+/g, " ").trim(); }
      function escapeHtml(s) { return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); }

      function findSuggestion(prefix) {
        const nq = normalize(prefix);
        if (!nq) return null;
        for (const p of processorsList) { const n = normalize(p); if (n.startsWith(nq) && n !== nq) return p; }
        for (const p of processorsList) { const n = normalize(p); if (n.includes(nq) && n !== nq) return p; }
        return null;
      }
      function findExactMatch(input) { const nq = normalize(input); return processorsList.find(p => normalize(p) === nq) || null; }
      function remainderFromPrefix(original, prefix) {
        const target = normalize(prefix); if (!target) return original; const originalNorm = normalize(original); const startIndex = originalNorm.indexOf(target); if (startIndex === -1) return original; let charCount = 0; let realIndex = 0; for (let i = 0; i < original.length; i++) { const ch = original[i]; if (/\s/.test(ch)) { if (charCount > 0 && !normalize(original.slice(0, i)).endsWith(" ")) { charCount++; } } else { charCount++; } if (charCount > startIndex + target.length) { realIndex = i; break; } } return original.slice(realIndex);
      }

      let currentSuggestion = null; let selectedDropdownIndex = -1;
      function showSuggestionFor(value) {
        const sug = findSuggestion(value); currentSuggestion = sug; if (!sug) { suggestionEl.innerHTML = ""; return null; }
        const prefix = value; const rem = remainderFromPrefix(sug, prefix); const safePrefix = escapeHtml(prefix); const safeRem = escapeHtml(rem);
        suggestionEl.innerHTML = `<span class="suggestion-prefix">${safePrefix}</span><span>${safeRem}</span>`; return sug;
      }
      function getFilteredProcessors(query) {
        if (!query) return processorsList; const nq = normalize(query); const exact = []; const starts = []; const contains = [];
        for (const p of processorsList) { const n = normalize(p); if (n === nq) exact.push(p); else if (n.startsWith(nq)) starts.push(p); else if (n.includes(nq)) contains.push(p); }
        return [...exact, ...starts, ...contains];
      }
      function showDropdown(query = "") {
        const filtered = getFilteredProcessors(query); selectedDropdownIndex = -1; if (filtered.length === 0) { senderDropdown.classList.add("hidden"); return; }
        senderDropdown.innerHTML = filtered.map((processor, index) => {
          const highlighted = escapeHtml(processor).replace(new RegExp(`(${escapeHtml(query).replace(/[.*+?^${}()|[\\]\\]/g, "\\$&")})`, "gi"), '<mark class="bg-yellow-200 font-semibold">$1</mark>');
          return `<div class="px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors duration-150 border-b border-gray-100 last:border-b-0" data-value="${escapeHtml(processor)}" data-index="${index}">${highlighted}</div>`;
        }).join("");
        senderDropdown.classList.remove("hidden");
      }
      function hideDropdown() { senderDropdown.classList.add("hidden"); selectedDropdownIndex = -1; }
      function selectDropdownItem(index) {
        const items = senderDropdown.querySelectorAll("[data-value]"); if (items.length > 0 && index >= 0 && index < items.length) {
          const value = items[index].dataset.value; senderSearch.value = value; senderHidden.value = value; hideDropdown(); suggestionEl.innerHTML = ""; currentSuggestion = null; updateInputState(); return true;
        } return false;
      }
      function updateInputState() {
        const hasValue = senderSearch.value.length > 0; const hasValidSelection = senderHidden.value.length > 0; senderSearch.classList.remove("border-green-500", "border-red-500", "border-yellow-500");
        if (!hasValue) senderSearch.classList.add("border-gray-200"); else if (hasValidSelection) { senderSearch.classList.remove("border-gray-200"); senderSearch.classList.add("border-green-500"); } else if (currentSuggestion) { senderSearch.classList.remove("border-gray-200"); senderSearch.classList.add("border-yellow-500"); } else { senderSearch.classList.remove("border-gray-200"); senderSearch.classList.add("border-red-500"); }
      }

      senderSearch.addEventListener("input", (e) => {
        const value = e.target.value; senderHidden.value = ""; clearBtn.classList.toggle("hidden", !value);
        const exactMatch = findExactMatch(value); if (exactMatch) { senderHidden.value = exactMatch; suggestionEl.innerHTML = ""; currentSuggestion = null; hideDropdown(); } else { showSuggestionFor(value); showDropdown(value); }
        updateInputState();
      });
      senderSearch.addEventListener("keydown", (e) => {
        const dropdownVisible = !senderDropdown.classList.contains("hidden"); const dropdownItems = senderDropdown.querySelectorAll("[data-value]");
        if (e.key === "ArrowDown") { e.preventDefault(); if (dropdownVisible && dropdownItems.length > 0) { selectedDropdownIndex = Math.min(selectedDropdownIndex + 1, dropdownItems.length - 1); updateDropdownSelection(); } else { showDropdown(senderSearch.value); } }
        else if (e.key === "ArrowUp") { e.preventDefault(); if (dropdownVisible && dropdownItems.length > 0) { selectedDropdownIndex = Math.max(selectedDropdownIndex - 1, -1); updateDropdownSelection(); } }
        else if (e.key === "Enter") { e.preventDefault(); if (dropdownVisible && selectedDropdownIndex >= 0) { selectDropdownItem(selectedDropdownIndex); } else { const exact = findExactMatch(senderSearch.value); if (exact) { senderHidden.value = exact; suggestionEl.innerHTML = ""; currentSuggestion = null; hideDropdown(); } else if (currentSuggestion) { senderSearch.value = currentSuggestion; senderHidden.value = currentSuggestion; currentSuggestion = null; suggestionEl.innerHTML = ""; hideDropdown(); } } clearBtn.classList.toggle("hidden", !senderSearch.value); updateInputState(); }
        else if (e.key === "Tab") { if (currentSuggestion) { e.preventDefault(); senderSearch.value = currentSuggestion; senderHidden.value = currentSuggestion; currentSuggestion = null; suggestionEl.innerHTML = ""; hideDropdown(); clearBtn.classList.toggle("hidden", !senderSearch.value); updateInputState(); } else if (dropdownVisible && selectedDropdownIndex >= 0) { e.preventDefault(); selectDropdownItem(selectedDropdownIndex); } else if (dropdownVisible && selectedDropdownIndex === -1) { e.preventDefault(); if (!selectDropdownItem(0)) hideDropdown(); } else { hideDropdown(); } }
        else if (e.key === "Escape") { suggestionEl.innerHTML = ""; currentSuggestion = null; hideDropdown(); updateInputState(); }
      });
      function updateDropdownSelection() { const items = senderDropdown.querySelectorAll("[data-value]"); items.forEach((item, index) => { if (index === selectedDropdownIndex) { item.classList.add("bg-blue-100"); item.scrollIntoView({ block: "nearest" }); } else { item.classList.remove("bg-blue-100"); } }); }
      senderSearch.addEventListener("blur", () => { setTimeout(() => { const exact = findExactMatch(senderSearch.value); if (exact) { senderSearch.value = exact; senderHidden.value = exact; } suggestionEl.innerHTML = ""; currentSuggestion = null; hideDropdown(); updateInputState(); }, 200); });
      senderSearch.addEventListener("focus", () => { if (senderSearch.value) { showSuggestionFor(senderSearch.value); showDropdown(senderSearch.value); } else { showDropdown(""); } updateInputState(); });
      senderDropdown.addEventListener("click", (e) => { const item = e.target.closest("[data-value]"); if (item) { const value = item.dataset.value; senderSearch.value = value; senderHidden.value = value; hideDropdown(); suggestionEl.innerHTML = ""; currentSuggestion = null; clearBtn.classList.toggle("hidden", !value); updateInputState(); senderSearch.focus(); } });
      clearBtn.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); senderSearch.value = ""; senderHidden.value = ""; clearBtn.classList.add("hidden"); suggestionEl.innerHTML = ""; currentSuggestion = null; hideDropdown(); updateInputState(); senderSearch.focus(); });
      document.addEventListener("click", (e) => { const wrap = senderSearch.closest(".autocomplete-wrap"); if (wrap && !wrap.contains(e.target)) hideDropdown(); });

      function humanFileSize(bytes) { if (bytes === 0) return "0 B"; const units = ["B", "KB", "MB", "GB", "TB"]; const i = Math.floor(Math.log(bytes) / Math.log(1024)); return (bytes / Math.pow(1024, i)).toFixed(i === 0 ? 0 : 1) + " " + units[i]; }
      function showSelectedFile(viewEl, zoneEl, nameEl, sizeEl, file) { nameEl.textContent = file.name; sizeEl.textContent = humanFileSize(file.size); viewEl.classList.remove("hidden"); zoneEl.classList.add("hidden"); zoneEl.setAttribute("aria-disabled", "true"); }
      function clearSelectedFile(input, viewEl, zoneEl) { try { input.value = ""; } catch { const newInput = input.cloneNode(); input.parentNode.replaceChild(newInput, input); location.reload(); } viewEl.classList.add("hidden"); zoneEl.classList.remove("hidden"); zoneEl.removeAttribute("aria-disabled"); }

      invoiceFileInput.addEventListener("change", (e) => { const f = e.target.files[0]; if (!f) return; if (!/\.(xlsx|xls)$/i.test(f.name)) { showNotification("Инвойс должен быть Excel (.xlsx/.xls)", "error"); invoiceFileInput.value = ""; return; } showSelectedFile(invoiceView, invoiceZone, invoiceFileName, invoiceFileSize, f); });
      declFileInput.addEventListener("change", (e) => { const f = e.target.files[0]; if (!f) return; if (!/\.xml$/i.test(f.name)) { showNotification("Декларация должна быть XML", "error"); declFileInput.value = ""; return; } showSelectedFile(declView, declZone, declFileName, declFileSize, f); });

      invoiceZone.addEventListener("dragover", (e) => { e.preventDefault(); if (!invoiceView.classList.contains("hidden")) { invoiceZone.classList.add("opacity-60"); return; } invoiceZone.classList.add("ring-2", "ring-blue-200"); });
      invoiceZone.addEventListener("dragleave", () => { invoiceZone.classList.remove("ring-2", "ring-blue-200", "opacity-60"); });
      invoiceZone.addEventListener("drop", (e) => { e.preventDefault(); invoiceZone.classList.remove("ring-2", "ring-blue-200", "opacity-60"); if (!invoiceView.classList.contains("hidden")) { showNotification("Сначала удалите текущий файл", "error"); return; } const f = e.dataTransfer?.files?.[0]; if (f && /\.(xlsx|xls)$/i.test(f.name)) { try { const dt = new DataTransfer(); dt.items.add(f); invoiceFileInput.files = dt.files; } catch {} showSelectedFile(invoiceView, invoiceZone, invoiceFileName, invoiceFileSize, f); } else { showNotification("Пожалуйста, выберите Excel (.xlsx/.xls)", "error"); } });
      invoiceZone.addEventListener("click", (e) => { if (!invoiceView.classList.contains("hidden")) { e.preventDefault(); showNotification("Удалите текущий файл", "error"); } });
      invoiceZone.addEventListener("keydown", (e) => { if ((e.key === "Enter" || e.key === " ") && invoiceView.classList.contains("hidden")) { invoiceFileInput.click(); } });
      removeInvoiceBtn.addEventListener("click", () => { clearSelectedFile(invoiceFileInput, invoiceView, invoiceZone); });

      declZone.addEventListener("dragover", (e) => { e.preventDefault(); if (!declView.classList.contains("hidden")) { declZone.classList.add("opacity-60"); return; } declZone.classList.add("ring-2", "ring-blue-200"); });
      declZone.addEventListener("dragleave", () => { declZone.classList.remove("ring-2", "ring-blue-200", "opacity-60"); });
      declZone.addEventListener("drop", (e) => { e.preventDefault(); declZone.classList.remove("ring-2", "ring-blue-200", "opacity-60"); if (!declView.classList.contains("hidden")) { showNotification("Сначала удалите текущий файл", "error"); return; } const f = e.dataTransfer?.files?.[0]; if (f && /\.xml$/i.test(f.name)) { try { const dt = new DataTransfer(); dt.items.add(f); declFileInput.files = dt.files; } catch {} showSelectedFile(declView, declZone, declFileName, declFileSize, f); } else { showNotification("Пожалуйста, выберите XML", "error"); } });
      declZone.addEventListener("click", (e) => { if (!declView.classList.contains("hidden")) { e.preventDefault(); showNotification("Удалите текущий файл", "error"); } });
      declZone.addEventListener("keydown", (e) => { if ((e.key === "Enter" || e.key === " ") && declView.classList.contains("hidden")) { declFileInput.click(); } });
      removeDeclBtn.addEventListener("click", () => { clearSelectedFile(declFileInput, declView, declZone); });

      compareForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!senderHidden.value) {
          const exact = findExactMatch(senderSearch.value);
          if (exact) { senderHidden.value = exact; senderSearch.value = exact; }
          else if (currentSuggestion) { senderHidden.value = currentSuggestion; senderSearch.value = currentSuggestion; }
        }
        if (!senderHidden.value) { showNotification("Пожалуйста, выберите отправителя", "error"); senderSearch.focus(); return; }
        if (!invoiceFileInput.files.length) { showNotification("Пожалуйста, выберите инвойс", "error"); return; }
        if (!/\.(xlsx|xls)$/i.test(invoiceFileInput.files[0].name)) { showNotification("Инвойс должен быть Excel", "error"); return; }
        if (!declFileInput.files.length) { showNotification("Пожалуйста, выберите декларацию", "error"); return; }
        if (!/\.xml$/i.test(declFileInput.files[0].name)) { showNotification("Декларация должна быть XML", "error"); return; }

        compareSubmit.disabled = true; compareSpinner.classList.remove("hidden"); setLoading(true);
        try {
          const fd = new FormData(compareForm);
          const resp = await fetch(compareForm.action || "/compare", { method: "POST", body: fd });
          const j = await resp.json().catch(() => ({}));
          if (!resp.ok || !j.success) { showNotification("Ошибка: " + (j.error || ("Сервер вернул " + resp.status)), "error"); }
          else {
            try { 
              localStorage.setItem("mapato_compare_result", JSON.stringify({ 
                invoice_file: j.data.invoice_file || "", 
                declaration_file: j.data.declaration_file || "",
                xml_table: j.data.xml_table || null
              })); 
            } catch {}
            location.href = "/compare";
          }
        } catch (err) { showNotification("Ошибка при отправке формы", "error"); }
        finally { setLoading(false); compareSpinner.classList.add("hidden"); compareSubmit.disabled = false; }
      });

      // Показать результат из localStorage: таблица XML + имя Excel файла
      (function initFromLocalStorage() {
        try {
          const raw = localStorage.getItem("mapato_compare_result");
          if (!raw) return;
          const data = JSON.parse(raw);
          
          // Компактный HTML для результата
          const files = `Инвойс: ${data.invoice_file || ""} | Декларация: ${data.declaration_file || ""}`;
          let table = '';
          
          if (data.xml_table?.rows?.length > 0) {
            const headers = data.xml_table.headers.map(h => `<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">${h}</th>`).join('');
            const rows = data.xml_table.rows.map((row, i) => 
              `<tr class="${i % 2 ? 'bg-gray-50' : 'bg-white'}">
                ${data.xml_table.headers.map(h => `<td class="px-3 py-2 text-sm text-gray-900">${row[h] || ''}</td>`).join('')}
              </tr>`
            ).join('');
            
            table = `
              <div class="mt-4">
                <h3 class="text-lg font-semibold mb-2">Товары из декларации (${data.xml_table.total_rows}):</h3>
                <div class="overflow-x-auto border rounded-lg">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr>${headers}</tr></thead>
                    <tbody>${rows}</tbody>
                  </table>
                </div>
              </div>`;
          } else if (data.xml_table?.error) {
            table = `<div class="mt-4 bg-red-50 border border-red-200 rounded-lg p-3"><p class="text-red-700">${data.xml_table.error}</p></div>`;
          }
          
          const content = `
            <div class="min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">
              <div class="bg-white rounded-2xl shadow-lg p-6 max-w-6xl w-full">
                <h1 class="text-xl font-bold text-gray-900 mb-4">Результат сравнения</h1>
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                  <p class="text-gray-700">${files}</p>
                </div>
                ${table}
                <div class="mt-6 text-center">
                  <button onclick="location.href='/compare'" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg transition-colors">
                    Загрузить другие файлы
                  </button>
                </div>
              </div>
            </div>`;
          
          document.body.innerHTML = content;
          localStorage.removeItem("mapato_compare_result");
        } catch (e) {
          console.error('Ошибка при отображении результата:', e);
        }
      })();
    </script>
  </body>
 </html>



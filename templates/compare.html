<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Результаты сравнения</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="/assets/favicon.png" type="image/png">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ["Inter", "system-ui", "sans-serif"] },
          },
        },
      };
    </script>
  </head>
  <body class="min-h-screen bg-slate-50 font-sans">
    <main class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-4">
      <div class="flex items-center justify-between bg-white rounded-lg shadow-sm border border-slate-200 px-6 py-4">
        <h1 class="text-lg font-semibold text-slate-800">Результаты сравнения</h1>
        <button onclick="goBackToUpload()" class="inline-flex items-center gap-2 px-4 py-2 border-2 border-slate-500 bg-slate-600 hover:bg-slate-700 text-white rounded-md transition-colors duration-200 text-sm font-medium shadow-sm">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
          </svg>
          Загрузить новый файл
        </button>
      </div>
      
      <!-- Блок с дополнительной информацией об инвойсе -->
      <div id="invoiceInfoContainer" class="hidden">
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
          <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-4 py-3">
            <h2 class="text-base font-medium text-white flex items-center">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              Общая информация
            </h2>
          </div>
          <div class="p-4">
            <div id="invoiceInfoContent"></div>
          </div>
        </div>
      </div>
      <div id="tableContainer"></div>
      <div id="emptyState" class="hidden">
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
          <p class="text-slate-600">Нет данных для отображения. Перейдите на страницу загрузки и выполните сравнение.</p>
        </div>
      </div>
    </main>

    <script>
      // Функция для форматирования чисел
      function formatNumber(value) {
        // Если это строка с множественными нулями, сначала очищаем её
        if (typeof value === 'string') {
          // Убираем лишние нули в конце
          value = value.replace(/\.?0+$/, '');
        }
        
        const num = parseFloat(value);
        if (isNaN(num)) return value;
        
        // Округляем до 2 знаков после запятой, чтобы убрать лишние нули
        const rounded = Math.round(num * 100) / 100;
        
        return rounded.toLocaleString('ru-RU', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 2
        });
      }

      // Глобальная переменная для хранения общей структуры столбцов
      let globalHeaders = [];
      let globalColumnWidths = {};

      // Общая функция для создания таблицы
      function createTableHtml(data, title, colorClass, iconPath, compareWith = null) {
        // Получаем заголовки из данных (из первой строки первого контейнера)
        let headers = [];
        for (const [containerName, rows] of Object.entries(data.containers)) {
          if (rows.length > 0) {
            headers = Object.keys(rows[0]);
            break;
          }
        }

        // Если это первая таблица, сохраняем структуру столбцов
        if (globalHeaders.length === 0) {
          globalHeaders = [...headers];
          // Определяем ширину столбцов в процентах для первой таблицы
          headers.forEach(header => {
            if (header === 'Коммерческое описание товара') {
              globalColumnWidths[header] = '25%';
            } else if (header === 'Код ТН ВЭД') {
              globalColumnWidths[header] = '10%';
            } else if (header === 'Номер контейнера') {
              globalColumnWidths[header] = '12%';
            } else if (header === 'Валюта') {
              globalColumnWidths[header] = '6%';
            } else if (header === 'Сумма') {
              globalColumnWidths[header] = '8%';
            } else if (header === 'Вес брутто') {
              globalColumnWidths[header] = '8%';
            } else {
              globalColumnWidths[header] = '7%';
            }
          });
        }

        // Используем глобальную структуру столбцов для всех таблиц
        headers = globalHeaders;
        
        // Получаем список номеров контейнеров
        const containerNumbers = Object.keys(data.containers);
        const containerDisplay = containerNumbers.length > 0 ? containerNumbers.join(', ') : 'Нет данных';
        
        const headerHtml = headers.map(h => {
          const width = globalColumnWidths[h] || '7%';
          return `<th class="px-2 py-2 text-left text-xs font-semibold text-slate-700 tracking-normal border-r border-slate-200" style="width: ${width}; min-width: ${width}; max-width: ${width};">${h}</th>`;
        }).join('');
        
        let allRows = [];
        for (const [containerName, rows] of Object.entries(data.containers)) {
          allRows = allRows.concat(rows);
        }
        
        // Рассчитываем итоги для числовых полей
        let totals = {};
        
        // Определяем числовые поля для суммирования
        const numericFields = ['Количество грузовых мест', 'Количество упаковок', 'Вес брутто', 'Сумма'];
        
        numericFields.forEach(field => {
          if (headers.includes(field)) {
            totals[field] = 0;
          }
        });
        
        allRows.forEach(row => {
          numericFields.forEach(field => {
            if (totals.hasOwnProperty(field)) {
              totals[field] += parseFloat(row[field]) || 0;
            }
          });
        });

        // Функция для сравнения значений
        function compareValues(val1, val2, header = '') {
          const str1 = (val1 ?? '').toString().trim();
          const str2 = (val2 ?? '').toString().trim();
          
          // Для кодов ТН ВЭД сравниваем только первые 6 цифр
          if (header === 'Код ТН ВЭД') {
            const code1 = str1.replace(/\D/g, '').substring(0, 6);
            const code2 = str2.replace(/\D/g, '').substring(0, 6);
            return code1 === code2;
          }
          
          // Для коммерческого описания товара используем специальную логику
          if (header === 'Коммерческое описание товара') {
            // Проверяем в обе стороны: слова из более короткого описания должны входить в более длинное
            const processed1 = str1.replace(/[^a-zA-Zа-яА-Я0-9\s]/g, '').toLowerCase().trim();
            const processed2 = str2.replace(/[^a-zA-Zа-яА-Я0-9\s]/g, '').toLowerCase().trim();
            
            const words1 = processed1.split(/\s+/).filter(word => word.length > 0);
            const words2 = processed2.split(/\s+/).filter(word => word.length > 0);
            
            // Если одно из описаний пустое, считаем совпадением
            if (words1.length === 0 || words2.length === 0) {
              return true;
            }
            
            // Определяем, какое описание короче - его слова должны входить в более длинное
            let shorterWords, longerWords;
            if (words1.length <= words2.length) {
              shorterWords = words1;
              longerWords = words2;
            } else {
              shorterWords = words2;
              longerWords = words1;
            }
            
            // Проверяем, входят ли все слова из более короткого описания в более длинное
            for (const shortWord of shorterWords) {
              let wordFound = false;
              for (const longWord of longerWords) {
                if (longWord.includes(shortWord) || shortWord.includes(longWord)) {
                  wordFound = true;
                  break;
                }
              }
              if (!wordFound) {
                return false;
              }
            }
            
            return true;
          }
          
          return str1 === str2;
        }


        // Получаем данные для сравнения (если есть)
        let comparisonRows = [];
        if (compareWith && compareWith.containers) {
          for (const [containerName, rows] of Object.entries(compareWith.containers)) {
            comparisonRows = comparisonRows.concat(rows);
          }
        }

        const rowsHtml = allRows.map((row, i) => `
          <tr class="hover:bg-slate-50 transition-colors duration-150 ${i % 2 === 0 ? 'bg-white' : 'bg-slate-50'}">
            ${headers.map(header => {
              // Определяем, является ли поле числовым
              const numericFields = ['Количество грузовых мест', 'Количество упаковок', 'Вес брутто', 'Сумма'];
              const isNumericField = numericFields.includes(header);
              
              let value;
              if (isNumericField && row[header] !== null && row[header] !== undefined && row[header] !== '') {
                value = formatNumber(row[header]);
              } else {
                value = (row[header] ?? '').toString().replace(/</g,'&lt;').replace(/>/g,'&gt;');
              }
              
              const width = globalColumnWidths[header] || '7%';
              
              // Проверяем состояние сравнения: 0 - равны (зеленый), 1 - неравны (красный), 2 - нет строки (фиолетовый)
              let comparisonState = 0; // по умолчанию равны (зеленый)
              if (comparisonRows.length > i) {
                const comparisonRow = comparisonRows[i];
                // Для числовых полей сравниваем исходные значения, а не отформатированные
                if (isNumericField) {
                  comparisonState = compareValues(row[header], comparisonRow[header], header) ? 0 : 1;
                } else {
                  comparisonState = compareValues(row[header], comparisonRow[header], header) ? 0 : 1;
                }
              } else {
                comparisonState = 2; // нет строки для сравнения (фиолетовый)
              }
              
              if (header === 'Коммерческое описание товара') {
                let cellClass = '';
                if (comparisonState === 0) {
                  cellClass = 'bg-green-100 border border-green-300 rounded p-1'; // равны - зеленый
                } else if (comparisonState === 1) {
                  cellClass = 'bg-red-100 border border-red-300 rounded p-1'; // неравны - красный
                } else {
                  cellClass = 'bg-purple-100 border border-purple-300 rounded p-1'; // нет строки - фиолетовый
                }
                
                return `<td class="px-2 py-1 text-sm text-slate-900 min-w-0 border-r border-slate-200" style="width: ${width}; min-width: ${width}; max-width: ${width};">
                  <div class="${cellClass}">
                    <div 
                      class="cursor-pointer overflow-hidden text-ellipsis p-0 m-0"
                      style="display: -webkit-box; -webkit-line-clamp: none; -webkit-box-orient: vertical; line-height: 1.2em; "
                      onclick="toggleTextExpansion(this)"
                      title="Нажмите для развертывания/свертывания"
                    >
                      ${value}
                    </div>
                  </div>
                </td>`;
              } else {
                let cellClass = '';
                if (comparisonState === 0) {
                  cellClass = 'bg-green-100 border border-green-300 rounded p-1'; // равны - зеленый
                } else if (comparisonState === 1) {
                  cellClass = 'bg-red-100 border border-red-300 rounded p-1'; // неравны - красный
                } else {
                  cellClass = 'bg-purple-100 border border-purple-300 rounded p-1'; // нет строки - фиолетовый
                }
                
                return `<td class="px-2 py-1 text-sm text-slate-900 min-w-0 border-r border-slate-200" style="width: ${width}; min-width: ${width}; max-width: ${width};">
                  <div class="${cellClass}">
                    <span class="p-0 m-0">${value}</span>
                  </div>
                </td>`;
              }
            }).join('')}
          </tr>
        `).join('');

        // Рассчитываем итоги для таблицы сравнения (если есть)
        let comparisonTotals = {};
        if (compareWith && compareWith.containers) {
          let comparisonAllRows = [];
          for (const [containerName, rows] of Object.entries(compareWith.containers)) {
            comparisonAllRows = comparisonAllRows.concat(rows);
          }
          
          numericFields.forEach(field => {
            if (headers.includes(field)) {
              comparisonTotals[field] = 0;
            }
          });
          
          comparisonAllRows.forEach(row => {
            numericFields.forEach(field => {
              if (comparisonTotals.hasOwnProperty(field)) {
                comparisonTotals[field] += parseFloat(row[field]) || 0;
              }
            });
          });
        }

        // Создаем строку итогов
        const totalsRowHtml = `
          <tr class="bg-slate-100 border-t-2 border-slate-300 font-medium">
            ${headers.map(header => {
              const width = globalColumnWidths[header] || '7%';
              
              if (totals.hasOwnProperty(header)) {
                // Округляем до 2 знаков после запятой, чтобы убрать лишние нули
                const roundedValue = Math.round(totals[header] * 100) / 100;
                const value = roundedValue.toLocaleString('ru-RU', {
                  minimumFractionDigits: 0,
                  maximumFractionDigits: 2
                });
                const roundedComparisonValue = comparisonTotals.hasOwnProperty(header) ? Math.round(comparisonTotals[header] * 100) / 100 : null;
                const comparisonValue = roundedComparisonValue ? roundedComparisonValue.toLocaleString('ru-RU', {
                  minimumFractionDigits: 0,
                  maximumFractionDigits: 2
                }) : '';
                
                let cellClass = '';
                if (!comparisonValue) {
                  cellClass = 'bg-purple-100 border border-purple-300 rounded p-1'; // нет данных для сравнения - фиолетовый
                } else if (compareValues(value, comparisonValue, header)) {
                  cellClass = 'bg-green-100 border border-green-300 rounded p-1'; // равны - зеленый
                } else {
                  cellClass = 'bg-red-100 border border-red-300 rounded p-1'; // неравны - красный
                }
                
                return `<td class="px-2 py-2 bg-slate-300 text-sm text-slate-800 whitespace-nowrap border-r border-slate-200" style="width: ${width}; min-width: ${width}; max-width: ${width};">
                  <div class="${cellClass}">
                    <span>${value}</span>
                  </div>
                </td>`;
              } else if (header === 'Код ТН ВЭД') {
                return `<td class="px-2 py-2 bg-slate-300 text-sm text-slate-800 whitespace-nowrap font-semibold border-r border-slate-200" style="width: ${width}; min-width: ${width}; max-width: ${width};">ИТОГО:</td>`;
              } else {
                return `<td class="px-2 py-2 bg-slate-300 text-sm text-slate-500 whitespace-nowrap border-r border-slate-200" style="width: ${width}; min-width: ${width}; max-width: ${width};"></td>`;
              }
            }).join('')}
          </tr>
        `;
        
        return `
          <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden mb-4">
            <div class="bg-gradient-to-r ${colorClass} px-4 py-3">
              <h2 class="text-base font-medium text-white flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  ${iconPath}
                </svg>
                ${title} — ${containerDisplay}
              </h2>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full border-collapse text-sm" style="table-layout: fixed;">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>${headerHtml}</tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                  ${rowsHtml}
                  ${totalsRowHtml}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }


      (function renderFromLocalStorage() {
        try {
          // Сбрасываем глобальные переменные для нового рендеринга
          globalHeaders = [];
          globalColumnWidths = {};
          
          // Скрываем блок с информацией об инвойсе
          const invoiceInfoContainer = document.getElementById("invoiceInfoContainer");
          if (invoiceInfoContainer) {
            invoiceInfoContainer.classList.add("hidden");
          }
          
          const raw = localStorage.getItem("mapato_compare_result");
          const container = document.getElementById("tableContainer");
          const empty = document.getElementById("emptyState");
          if (!raw) { empty.classList.remove("hidden"); return; }

          const data = JSON.parse(raw);
          let tableHtml = '';
          // Проверяем наличие данных
          if (!data || (!data.xml_data && !data.invoice_data)) {
            empty.classList.remove("hidden");
            return;
          }


          // Таблица XML данных в формате ExcelData (если доступна)
          if (data && data.xml_data && data.xml_data.containers && Object.keys(data.xml_data.containers).length > 0) {
            const xmlIconPath = `<rect x="3" y="5" width="18" height="14" rx="2" ry="2" stroke-width="2"/><line x1="3" y1="9" x2="21" y2="9" stroke-width="2"/><line x1="9" y1="9" x2="9" y2="19" stroke-width="2"/><line x1="15" y1="9" x2="15" y2="19" stroke-width="2"/>`;
            // Передаем данные инвойса для сравнения, если они есть
            const compareWith = (data && data.invoice_data && data.invoice_data.containers && Object.keys(data.invoice_data.containers).length > 0) ? data.invoice_data : null;
            tableHtml += createTableHtml(data.xml_data, "Данные из ТД", "from-slate-600 to-slate-700", xmlIconPath, compareWith);
          }

          // Отображаем дополнительную информацию об инвойсе
          if (data && (data.invoice_data || data.xml_data)) {
            const invoiceInfoContainer = document.getElementById("invoiceInfoContainer");
            const invoiceInfoContent = document.getElementById("invoiceInfoContent");
            
            if (invoiceInfoContainer && invoiceInfoContent) {
              let infoHtml = '';
              
              // Секция данных из инвойса
              if (data.invoice_data) {
                const invoiceInfo = data.invoice_data;
                
                infoHtml += `
                  <div class="mb-2">
                    <div class="flex items-center mb-2">
                      <div class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center mr-3">
                        <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                      </div>
                      <h3 class="text-lg font-semibold text-slate-800">Данные из инвойса</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                `;
                
                // Блок отправителя из инвойса
                infoHtml += `
                  <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 hover:shadow-sm transition-shadow">
                    <div class="flex items-center mb-3">
                      <svg class="w-4 h-4 text-slate-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                      </svg>
                      <span class="text-sm font-semibold text-slate-800">Отправитель</span>
                    </div>
                    <div class="space-y-2">
                      <div>
                        <div class="text-xs font-medium text-slate-700 mb-1">Название</div>
                        <div class="bg-slate-100 border border-slate-300 rounded p-1">
                          <div class="text-sm text-slate-900 break-words leading-relaxed font-medium">${invoiceInfo.sender_name || 'Нет данных'}</div>
                        </div>
                      </div>
                      <div>
                        <div class="text-xs font-medium text-slate-700 mb-1">Адрес</div>
                        <div class="bg-slate-100 border border-slate-300 rounded p-1">
                          <div class="text-sm text-slate-900 break-words leading-relaxed font-medium">${invoiceInfo.sender_address || 'Нет данных'}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
                
                // Блок получателя из инвойса
                infoHtml += `
                  <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 hover:shadow-sm transition-shadow">
                    <div class="flex items-center mb-3">
                      <svg class="w-4 h-4 text-slate-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                      </svg>
                      <span class="text-sm font-semibold text-slate-800">Получатель</span>
                    </div>
                    <div class="space-y-2">
                      <div>
                        <div class="text-xs font-medium text-slate-700 mb-1">Название</div>
                        <div class="bg-slate-100 border border-slate-300 rounded p-1">
                          <div class="text-sm text-slate-900 break-words leading-relaxed font-medium">${invoiceInfo.recipient_name || 'Нет данных'}</div>
                        </div>
                      </div>
                      <div>
                        <div class="text-xs font-medium text-slate-700 mb-1">Адрес</div>
                        <div class="bg-slate-100 border border-slate-300 rounded p-1">
                          <div class="text-sm text-slate-900 break-words leading-relaxed font-medium">${invoiceInfo.recipient_address || 'Нет данных'}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
                
                infoHtml += `
                    </div>
                  </div>
                `;
              }
              
              // Секция данных из XML
              if (data.xml_data && (data.xml_data.sender_name || data.xml_data.sender_address || data.xml_data.recipient_name || data.xml_data.recipient_address || data.xml_data.departure_country_code || data.xml_data.destination_country_code)) {
                const xmlData = data.xml_data;
                
                infoHtml += `
                  <div class="">
                    <div class="flex items-center mb-2">
                      <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                      </div>
                      <h3 class="text-lg font-semibold text-slate-800">Данные из ТД (XML)</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                `;
                
                // Блок отправителя из XML
                infoHtml += `
                  <div class="bg-blue-50 rounded-lg p-4 border border-blue-200 hover:shadow-sm transition-shadow">
                    <div class="flex items-center mb-3">
                      <svg class="w-4 h-4 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                      </svg>
                      <span class="text-sm font-semibold text-blue-800">Отправитель</span>
                    </div>
                    <div class="space-y-2">
                      <div>
                        <div class="text-xs font-medium text-blue-700 mb-1">Название</div>
                        <div class="bg-blue-100 border border-blue-300 rounded p-1">
                          <div class="text-sm text-blue-900 break-words leading-relaxed font-medium">${xmlData.sender_name || 'Нет данных'}</div>
                        </div>
                      </div>
                      <div>
                        <div class="text-xs font-medium text-blue-700 mb-1">Адрес</div>
                        <div class="bg-blue-100 border border-blue-300 rounded p-1">
                          <div class="text-sm text-blue-900 break-words leading-relaxed font-medium">${xmlData.sender_address || 'Нет данных'}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
                
                // Блок получателя из XML
                infoHtml += `
                  <div class="bg-blue-50 rounded-lg p-4 border border-blue-200 hover:shadow-sm transition-shadow">
                    <div class="flex items-center mb-3">
                      <svg class="w-4 h-4 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                      </svg>
                      <span class="text-sm font-semibold text-blue-800">Получатель</span>
                    </div>
                    <div class="space-y-2">
                      <div>
                        <div class="text-xs font-medium text-blue-700 mb-1">Название</div>
                        <div class="bg-blue-100 border border-blue-300 rounded p-1">
                          <div class="text-sm text-blue-900 break-words leading-relaxed font-medium">${xmlData.recipient_name || 'Нет данных'}</div>
                        </div>
                      </div>
                      <div>
                        <div class="text-xs font-medium text-blue-700 mb-1">Адрес</div>
                        <div class="bg-blue-100 border border-blue-300 rounded p-1">
                          <div class="text-sm text-blue-900 break-words leading-relaxed font-medium">${xmlData.recipient_address || 'Нет данных'}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
                
                
                infoHtml += `
                    </div>
                  </div>
                `;
              }
              
             
              
              // Три вертикальных блока: Страны, Пломбы, ЖД накладная
              (function appendTripletBlocks() {
                const xmlData = data.xml_data || {};
                const departureCode = (xmlData.departure_country_code || '').toString();
                const destinationCode = (xmlData.destination_country_code || '').toString();
                const sealQty = (typeof xmlData.seal_quantity !== 'undefined' && xmlData.seal_quantity !== null) ? xmlData.seal_quantity : '';
                const sealIdsArr = Array.isArray(xmlData.seal_ids) ? xmlData.seal_ids : [];
                const sealIdsDisplay = sealIdsArr.length > 0 ? sealIdsArr.map(x => (x ?? '').toString().replace(/</g,'&lt;').replace(/>/g,'&gt;')).join(', ') : '';
                // Найдём ЖД накладную (02013)
                let railDocId = '';
                let railDocDate = '';
                if (data.xml_documents && data.xml_documents.length > 0) {
                  const railDoc = data.xml_documents.find(doc => {
                    const name = (doc.DocName || '').toString().toLowerCase();
                    return doc.DocKindCode === '02013' || name.includes('жд наклад') || name.includes('железнодорож');
                  });
                  if (railDoc) {
                    railDocId = (railDoc.DocId || '').toString().replace(/</g,'&lt;').replace(/>/g,'&gt;');
                    railDocDate = (railDoc.DocCreationDate || '').toString().replace(/</g,'&lt;').replace(/>/g,'&gt;');
                  }
                }
                // Показываем блоки, даже если часть данных отсутствует
                infoHtml += `
                  <div class="mt-3">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <!-- Блок Страны -->
                      <div class="bg-white rounded-lg border border-slate-200 shadow-sm">
                        <div class="px-4 py-2 border-b border-slate-200 flex items-center">
                          <svg class="w-4 h-4 text-slate-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2a10 10 0 100 20 10 10 0 000-20z"/>
                          </svg>
                          <span class="text-sm font-semibold text-slate-800">Страны</span>
                        </div>
                        <div class="p-4">
                          <div class="text-xs font-medium text-slate-600 mb-2">Маршрут</div>
                          <div class="flex items-center gap-3">
                            <!-- Отправление -->
                            <div class="flex flex-col items-start">
                              <span class="text-[10px] uppercase tracking-wide text-slate-500 mb-1">Отправление</span>
                              <span class="inline-flex items-center rounded-full px-3 py-1 bg-slate-50 border border-slate-200 text-sm font-semibold text-slate-900">
                                ${departureCode ? departureCode.replace(/</g,'&lt;').replace(/>/g,'&gt;') : 'Нет данных'}
                              </span>
                            </div>
                            <!-- Линия маршрута с стрелкой -->
                            <div class="relative flex-1 h-7 flex items-center">
                              <div class="w-full h-[2px] bg-gradient-to-r from-slate-200 via-slate-300 to-slate-200"></div>
                              <svg class="absolute left-1/2 -translate-x-1/2 w-5 h-5 text-slate-500 bg-white rounded-full shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                              </svg>
                            </div>
                            <!-- Назначение -->
                            <div class="flex flex-col items-end">
                              <span class="text-[10px] uppercase tracking-wide text-slate-500 mb-1">Назначение</span>
                              <span class="inline-flex items-center rounded-full px-3 py-1 bg-slate-50 border border-slate-200 text-sm font-semibold text-slate-900">
                                ${destinationCode ? destinationCode.replace(/</g,'&lt;').replace(/>/g,'&gt;') : 'Нет данных'}
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <!-- Блок Пломбы -->
                      <div class="bg-white rounded-lg border border-slate-200 shadow-sm">
                        <div class="px-4 py-2 border-b border-slate-200 flex items-center">
                          <svg class="w-4 h-4 text-slate-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a5 5 0 10-10 0v2H5a2 2 0 00-2 2v7a2 2 0 002 2h14a2 2 0 002-2v-7a2 2 0 00-2-2h-2zM9 7a3 3 0 016 0v2H9V7z"/>
                          </svg>
                          <span class="text-sm font-semibold text-slate-800">Пломбы</span>
                        </div>
                        <div class="p-4 space-y-3">
                          <div>
                            <div class="text-xs font-medium text-slate-600 mb-1">Количество пломб</div>
                            <div class="bg-slate-50 border border-slate-200 rounded p-1"><div class="text-sm text-slate-900">${(sealQty === '' ? 'Нет данных' : sealQty)}</div></div>
                          </div>
                          <div>
                            <div class="text-xs font-medium text-slate-600 mb-1">Номера пломб</div>
                            <div class="bg-slate-50 border border-slate-200 rounded p-1"><div class="text-sm text-slate-900">${sealIdsDisplay || 'Нет данных'}</div></div>
                          </div>
                        </div>
                      </div>
                      <!-- Блок ЖД накладная -->
                      <div class="bg-white rounded-lg border border-slate-200 shadow-sm">
                        <div class="px-4 py-2 border-b border-slate-200 flex items-center">
                          <svg class="w-4 h-4 text-slate-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414A1 1 0 0117 4.707V19a2 2 0 01-2 2z"/>
                          </svg>
                          <span class="text-sm font-semibold text-slate-800">ЖД накладная</span>
                        </div>
                        <div class="p-4 space-y-3">
                          <div>
                            <div class="text-xs font-medium text-slate-600 mb-1">Номер</div>
                            <div class="bg-slate-50 border border-slate-200 rounded p-1"><div class="text-sm text-slate-900">${railDocId || 'Нет данных'}</div></div>
                          </div>
                          <div>
                            <div class="text-xs font-medium text-slate-600 mb-1">Дата</div>
                            <div class="bg-slate-50 border border-slate-200 rounded p-1"><div class="text-sm text-slate-900">${railDocDate || 'Нет данных'}</div></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              })();

              invoiceInfoContent.innerHTML = infoHtml;
              invoiceInfoContainer.classList.remove("hidden");
            }
          }

          // Таблица данных инвойса
          if (data && data.invoice_data && data.invoice_data.containers && Object.keys(data.invoice_data.containers).length > 0) {
            const invoiceIconPath = `<rect x="3" y="5" width="18" height="14" rx="2" ry="2" stroke-width="2"/><line x1="3" y1="9" x2="21" y2="9" stroke-width="2"/><line x1="9" y1="9" x2="9" y2="19" stroke-width="2"/><line x1="15" y1="9" x2="15" y2="19" stroke-width="2"/>`;
            // Передаем данные XML для сравнения, если они есть
            const compareWith = (data && data.xml_data && data.xml_data.containers && Object.keys(data.xml_data.containers).length > 0) ? data.xml_data : null;
            tableHtml += createTableHtml(data.invoice_data, "Данные из Инвойса", "from-slate-700 to-slate-800", invoiceIconPath, compareWith);
          } else if (data && data.invoice_data) {
            // Есть invoice_data, но нет контейнеров - показываем ошибку
            tableHtml += `
              <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
                <h3 class="text-base font-medium text-amber-800 mb-2">Этого контейнера нету в инвойсе</h3>
                <p class="text-amber-700 text-sm">Инвойс был обработан, но внутри именно этого контейнера нет, проверьте данные инвойса есть ли там этот контейнер</p>
                </div>
            `;
          } else {
            // Совсем нет данных об инвойсе
            tableHtml += `
              <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 mb-4">
                <h3 class="text-base font-medium text-slate-700 mb-2">Данные инвойса</h3>
                <p class="text-slate-600 text-sm">Инвойс не был загружен или обработан.</p>
              </div>
            `;
          }

          // Отображение документов из XML в конце (если есть)
          if (data.xml_documents && data.xml_documents.length > 0) {
            const documentsHtml = data.xml_documents.map(doc => {
              const kind = (doc.DocKindCode || '').toString().replace(/</g,'&lt;').replace(/>/g,'&gt;');
              console.log(doc.DocName);
              const name = (doc.DocName || '').toString().replace(/</g,'&lt;').replace(/>/g,'&gt;');
              const id = (doc.DocId || '').toString().replace(/</g,'&lt;').replace(/>/g,'&gt;');
              const date = (doc.DocCreationDate || '').toString().replace(/</g,'&lt;').replace(/>/g,'&gt;');
              
              const hasError = doc.has_error || false;
              const errorMessage = doc.error_message || '';
              
              return `
                <tr class="${hasError ? 'bg-red-50 border-l-4 border-red-400' : 'bg-white hover:bg-slate-50'} transition-colors">
                  <td class="px-3 py-2 text-sm">
                    <div class="flex items-center gap-2">
                      <div class="w-6 h-6 ${hasError ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-600'} rounded flex items-center justify-center flex-shrink-0">
                        ${hasError ? 
                          `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                          </svg>` :
                          `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                          </svg>`
                        }
                      </div>
                      <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${hasError ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-700'}">
                        ${kind || 'Документ'}
                      </span>
                    </div>
                  </td>
                  <td class="px-3 py-2 text-sm text-slate-900 max-w-0">
                    ${name|| '—'}
                  </td>
                  <td class="px-3 py-2 text-sm text-slate-600 font-mono">
                    ${id || '—'}
                  </td>
                  <td class="px-3 py-2 text-sm text-slate-600">
                    ${date || '—'}
                  </td>
                  <td class="px-3 py-2 text-sm">
                    ${hasError ? 
                      `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700">
                        Ошибка
                      </span>
                      <div class="text-xs text-red-600 mt-1">${errorMessage}</div>` : 
                      `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700">
                        OK
                      </span>`
                    }
                  </td>
                </tr>
              `;
            }).join('');

            // Подсчитываем документы с ошибками
            const errorCount = data.xml_documents.filter(doc => doc.has_error).length;
            const headerColor = errorCount > 0 ? 'from-red-600 to-red-700' : 'from-slate-600 to-slate-700';
            
            tableHtml += `
              <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden mb-4">
                <div class="bg-gradient-to-r ${headerColor} px-4 py-3">
                  <h2 class="text-base font-medium text-white flex items-center justify-between">
                    <div class="flex items-center">
                      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                      </svg>
                      Документы из XML
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                      <span class="bg-white bg-opacity-20 px-2 py-1 rounded">${data.xml_documents.length} всего</span>
                      ${errorCount > 0 ? `<span class="bg-red-500 px-2 py-1 rounded">${errorCount} с ошибками</span>` : ''}
                    </div>
                  </h2>
                </div>
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead class="bg-slate-50 border-b border-slate-200">
                      <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-slate-700">Тип</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-slate-700">Название</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-slate-700">ID</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-slate-700">Дата</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-slate-700">Статус</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                      ${documentsHtml}
                    </tbody>
                  </table>
                </div>
              </div>
            `;
          }


          container.innerHTML = tableHtml;
        } catch (e) {
          console.error('Ошибка при отображении результата:', e);
          document.getElementById("emptyState").classList.remove("hidden");
        }
      })();

      // Функция для развертывания/свертывания текста в столбце "Коммерческое описание товара"
      function toggleTextExpansion(element) {
        const isExpanded = element.style.webkitLineClamp === 'none';
        
        if (isExpanded) {
          // Свернуть текст
          element.style.webkitLineClamp = '1';
          element.title = 'Нажмите для развертывания/свертывания';
        } else {
          // Развернуть текст
          element.style.webkitLineClamp = 'none';
          element.title = 'Нажмите для развертывания/свертывания';
        }
      }

      // Функция для перехода на страницу загрузки с очисткой данных
      function goBackToUpload() {
        localStorage.removeItem("mapato_compare_result");
        window.location.href = "/";
      }
    </script>
  </body>
</html>
